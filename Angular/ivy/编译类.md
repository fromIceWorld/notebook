# CompilerFacadeImpl

```typescript
`ç¼–è¯‘å™¨çš„å®¹å™¨`ï¼šå†…éƒ¨åŒ…å«ã€ç®¡é“ç¼–è¯‘ï¼Œæ³¨å…¥ç¼–è¯‘ï¼Œæ¨¡å—ç¼–è¯‘ï¼ŒæŒ‡ä»¤ç¼–è¯‘ï¼Œç»„ä»¶ç¼–è¯‘ç­‰å‡½æ•°ã€‘
`compileComponent`:ç»„ä»¶ç¼–è¯‘

AppComponentçš„ç¼–è¯‘ç»“æœï¼š'./ç¼–è¯‘ç»“æœæ–‡ä»¶/AppComponent.js'
```

## compileComponent

`ç»„ä»¶ç¼–è¯‘[jitæ¨¡å¼ä¸‹]`

```typescript
ç»„ä»¶çš„ç¼–è¯‘æ˜¯åœ¨ `Éµcmp[ngComponentDef]` çš„ geté˜¶æ®µã€‚ç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹ï¼š
`1.`template:æ¨¡æ¿å­å­—ç¬¦ä¸²
`2.`tokenize:é€šè¿‡é…ç½®[æ’å€¼è¯­æ³•ï¼Œæ— æ•ˆå­—ç¬¦è¡¨ï¼Œç©ºæ ¼å­—ç¬¦æ˜¯å¦ä¿ç•™,....]è§£ætemplateç”Ÿæˆ tokenè¡¨
`3.`_TreeBuilderï¼šæ ¹æ®tokens,å°†èŠ‚ç‚¹å¤„ç†æˆastï¼Œå»é™¤æ— æ•ˆèŠ‚ç‚¹[åˆå¹¶ç©ºç™½èŠ‚ç‚¹ï¼Œå»é™¤'\n'] 
`4.`htmlAstToRender3Ast:å¤„ç†èŠ‚ç‚¹çš„ngç‰¹æ®Šå±æ€§[ä¼ è¾“å€¼ï¼Œç»‘å®šäº‹ä»¶ï¼Œç‰¹æ®ŠèŠ‚ç‚¹[â€˜ng-templateâ€™],æŒ‡ä»¤ç­‰]
	 Element/TemplateèŠ‚ç‚¹ï¼š'[prop]':å­˜å…¥inputså±æ€§ä¸­; '(eventName)':å­˜å…¥outputsä¸­; '#æ ‡è®°å'ï¼šå­˜å…¥referencesä¸­
     		  'æ™®é€šå±æ€§'ï¼šå­˜å…¥attributesä¸­; 'å­èŠ‚ç‚¹'ï¼šå­˜å…¥children
     TemplateèŠ‚ç‚¹ï¼š'let-name'ï¼šå£°æ˜å±æ€§å­˜å…¥ variables; 
                 'ngTemplateOutlet' å’Œ 'ngTemplateOutletContext'å­˜å…¥ templateAttrs
`5.`BindingParser: è§£ææ¨¡æ¿å’ŒæŒ‡ä»¤å®¿ä¸»åŒºåŸŸä¸­çš„ç»‘å®š,å°†NgComponentDefæ‰€éœ€çš„templateæ•°æ®è¿›è¡Œtokenè½¬æ¢ï¼Œæœ€ç»ˆè½¬æ¢æˆExpression 
`6.`definitionMap: ä¼šè§£æ NgComponentDef çš„ ç»„ä»¶åŸºç¡€æ•°æ®è§£ææˆExpressionä¸ä¸Šä¸€æ­¥è§£ææ¨¡æ¿çš„è¡¨è¾¾å¼åˆå¹¶
`7.`jitExpressionï¼šå°†ç»„ä»¶åŸºç¡€Expressionå’Œç»„ä»¶æ¨¡æ¿Expression åˆå¹¶è½¬æ¢æˆ ä»£ç è¾“å‡ºã€NgComponentDefã€‘ã€‚
```

`2.`tokenizeæ¨¡æ¿è§£æ

```typescript
`é€šè¿‡ASCII å¯¹æ¯” è§£æã€<tag, <--, <![, </tagã€‘`
tokensï¼štokené›†åˆğŸ§©
_currentTokenStartï¼šå½“å‰tokençš„å…¶å®çŠ¶æ€
_currentTokenTypeï¼šå½“å‰token çš„ç±»å‹ã€å¼€å§‹æ ‡ç­¾ï¼Œtextï¼Œé—­åˆæ ‡ç­¾ï¼Œæ³¨é‡Š,....ã€‘
_inInterpolationï¼šæ ‡è®°å½“å‰è§£ææ˜¯å¦åœ¨æ’å€¼è¯­æ³•ã€{{}}ã€‘å†…
end:è®°å½•template çš„é•¿åº¦
state:{
    column:3     //å½“å‰åˆ—
    line:0       //å½“å‰è¡Œ    é‡åˆ° [\n] å¢åŠ 
    offset:3     //å½“å‰ä½ç½®
    peek:105     //å½“å‰å­—ç¬¦çš„ ASCIIå€¼  peek == $EOF ã€offset >= endã€‘ æ—¶ ç»“æŸ
}
advanceå‡½æ•°ï¼Œæ›´æ–°stateï¼Œä¸æ–­æ¨è¿›offsetã€‚

æ ¹æ®ç±»åˆ«ç”Ÿæˆtoken:{
    typeï¼štokençš„ç±»å‹ï¼Œã€å¼€å§‹æ ‡ç­¾ï¼Œé—­åˆæ ‡ç­¾,....ã€‘
    partsï¼šã€å…³é”®å­—æ®µï¼Œæ¯”å¦‚[tagå‰ç¼€ï¼Œtag],ã€‘
    sourceSpanï¼šè®°å½•tokençš„åæ ‡[è¡Œï¼Œåˆ—ï¼Œç¬¬å‡ ä¸ªå­—ç¬¦]åŠ æ‰€å±æ–‡ä»¶uriå’Œæ€»æ¨¡æ¿å†…å®¹content
}

---å¼€å§‹æ ‡ç­¾---
<tagnameï¼Œè§£æåˆ°æ ‡ç­¾åï¼Œç»§ç»­å°è¯•è§£æå±æ€§ã€ç›´åˆ°é‡åˆ°['>','/','<']ã€‘ï¼Œå°†è§£æçš„å±æ€§token æ”¾å…¥tokensä¸­

---é—­åˆæ ‡ç­¾----
é‡åˆ°'/' + 'tagname' + '>';ç”Ÿæˆé—­åˆæ ‡ç­¾çš„tokenï¼› 

---text----
é‡åˆ°textï¼Œéœ€è¦è€ƒè™‘æ’å€¼è¯­æ³•ï¼š{{}}ï¼Œé‡åˆ°'{{'è¿›è¡Œæ ‡è®°[_inInterpolation],å†å»å°è¯•'}}'
textçš„ç»“æŸæ ‡å¿—åˆ¤æ–­ï¼šé‡åˆ°'<',ç»“æŸtextï¼Œå†ç»§ç»­åˆ¤æ–­

`tokenize` åªæ˜¯å°†æ ‡ç­¾ å’Œå±æ€§è¿›è¡Œåˆ†ç¦»è§£æã€‚
```

`3.`_TreeBuilder

```typescript
`é€šè¿‡tokensä¸­çš„æ ‡è®°ï¼Œå»ºç«‹å±‚çº§èŠ‚ç‚¹å…³ç³»æ ‘ğŸ„`
tokensï¼štokenize çš„è§£æç»“æœã€‚
_indexï¼štokensçš„æ ‡å¿—ä½ï¼Œæ ‡è®°å½“å‰è§£ætoken
_elementStackï¼šèŠ‚ç‚¹æ ˆï¼Œå¤„ç†èŠ‚ç‚¹å…³ç³»ã€‚
rootNodesï¼šä¿å­˜æ ¹èŠ‚ç‚¹

å¤„ç†è¿‡ç¨‹ï¼šå°†attribute token åˆå¹¶åˆ° <å¼€å§‹èŠ‚ç‚¹>tokenï¼Œæ¸…é™¤'\n'ï¼Œåˆå¹¶å¤šç©ºç™½å­—ç¬¦ï¼Œå°†å­èŠ‚ç‚¹åˆå¹¶åˆ°çˆ¶èŠ‚ç‚¹çš„childrenä¸­
```

`4.`htmlAstToRender3Ast

```typescript
`å°†è§£æçš„æ™®é€šastèŠ‚ç‚¹ï¼Œè½¬æ¢ä¸ºivyè¦ä½¿ç”¨çš„æ ¼å¼ã€å¯¹äºç‰¹æ®Šå±æ€§[æŒ‡ä»¤],ç‰¹æ®Štagçš„æ ‡è®°,æ’å€¼è¯­æ³•ã€‘`:å®é™…æ˜¯å¯¹äºngè¯­æ³•çš„æ ‡è®°

`---é¢„è§£æ--------`
èŠ‚ç‚¹å±æ€§ï¼š['select','href','rel','ngNonBindable','ngProjectAs']
          'select':select ä¸ºç©ºå°±ä¼šè¢«è®¾ç½®ä¸º'*'
èŠ‚ç‚¹ç±»å‹:['NG_CONTENT','STYLE','STYLESHEET','SCRIPT','OTHER']
		 'STYLESHEET': <link rel="stylesheet">
é€šè¿‡é¢„è§£æï¼Œç¡®å®šèŠ‚ç‚¹ç±»å‹ï¼Œå†ç­–ç•¥å¤„ç†ã€‚             
             
`--text---`
1-æŸ¥æ‰¾â€˜{{}}â€™,
2-å¦‚æœæœ‰æ’å€¼è¯­æ³•ï¼Œå†æŸ¥æ‰¾ pipe
æ ¹æ®textæ˜¯å¦æ˜¯åŠ¨æ€ã€æ’å€¼è¯­æ³•,pipeã€‘çš„ç”Ÿæˆä¸åŒçš„å®ä¾‹ã€Text,BoundTextã€‘
å¯¹äºTextï¼Œåœ¨ä¸‹ä¸€é˜¶æ®µä¼šåªç”ŸæˆcreationInstruction
å¯¹äºBoundText,åœ¨ä¸‹ä¸€é˜¶æ®µä¼šç”ŸæˆcreationInstruction å’Œ updateInstructionWithAdvance


`--èŠ‚ç‚¹----`
Element{
    children: å­èŠ‚ç‚¹
    attributes: èŠ‚ç‚¹å±æ€§
    references: #name ä¼šè¢«æ”¾å…¥ã€å­˜æ”¾æ ‡è®°çš„åœ°æ–¹ã€‘
    outputs:  ç»‘å®šçš„äº‹ä»¶
    name:'div'
    inputs: è¾“å…¥å±æ€§ï¼šã€è¢«[]åŒ…è£¹çš„å±æ€§ã€‘
    i18n:
    ParseSourceSpanï¼š æºæ–‡ä»¶çš„è®°å½•
    souceSpanï¼šæºæ–‡ä»¶çš„è®°å½•
    endSourceSpan: èŠ‚ç‚¹ç»“æŸä½ç½®çš„è®°å½•
    
}

`---ng-container---`
è§£æ 'ngTemplateOutlet' å’Œ 'ngTemplateOutletContext'ä¸¤ä¸ª BoundAttribute

`å¯¹äºæ¨¡æ¿ç±»å‹ï¼Œä¼šåˆ›é€ ä¸€ä¸ªtemplate å°†è‡ªèº«èŠ‚ç‚¹åŒ…è£¹`

Template{
        tagName, 
        attributes, 
        inputs, 
        outputs, 
        templateAttrs,  //å­˜å‚¨ æ¨¡æ¿å±æ€§ã€BoundAttributeã€‘
        children, è¿™ä¸ªchildren å°±æ˜¯è¢«åŒ…è£¹çš„ã€ng-containerèŠ‚ç‚¹ã€‘
        references, 
        variables, 
        sourceSpan, 
        startSourceSpan, 
        endSourceSpan, i18n
    
}
`---ng-template---`
ä¹Ÿä¼šç”Ÿæˆ template èŠ‚ç‚¹
```

`5.`BindingParser / constantPool

```typescript
`compileComponentFromMeta`:æ ¹æ®astèŠ‚ç‚¹åŠæŒ‡ä»¤å…ƒæ•°æ®ï¼Œç”Ÿæˆæ›´æ–°/åˆ›å»ºæŒ‡ä»¤å¯¹åº”çš„ã€astä»£ç è¯­å¥tokenå¹¶æ‹¼æ¥ç”Ÿæˆtemplateå‡½æ•°ã€‘ã€‚
åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šNgComponentDef ä¸­åŸºç¡€å±æ€§çš„ã€ä»£ç tokenã€‘`[compileComponentFromMetadata](definitionMapä¸­ä¸åŒ…æ‹¬
              templateçš„ä»£ç )`
		   templateæ¨¡æ¿åˆ›å»º/æ›´æ–°çš„ã€ä»£ç tokenã€‘`[TemplateDefinitionBuilder ]`
ä¾‹å¦‚[åŠ¨æ€çš„æ ·å¼,ç»‘å®šçš„å±æ€§å€¼,æŒ‡ä»¤,.... ]ã€‚æœ€ç»ˆæ‹¼æ¥æˆå®Œæ•´çš„ï¼š ã€NgComponentDefã€‘å‡½æ•°
templateèŠ‚ç‚¹å¯¹åº”çš„Â·æŒ‡ä»¤å‡½æ•°Â·[åˆ†ä¸ºä¸¤ä¸ªæ¨¡å¼ï¼šåˆ›å»ºæ¨¡å¼,æ›´æ–°æ¨¡å¼]ã€‚



æ ¹æ®èŠ‚ç‚¹çš„ç±»å‹ã€Elementï¼ŒTemplateã€‘,æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼
`_creationCodeFns`ï¼šåˆ›å»ºèŠ‚ç‚¹æ‰€ç”¨åˆ°çš„å‡½æ•°
`_updateCodeFns`:æ›´æ–°èŠ‚ç‚¹æ‰€ç”¨åˆ°çš„å‡½æ•°

`---ElementèŠ‚ç‚¹---`
ElementèŠ‚ç‚¹ï¼š{
    spanï¼šèŠ‚ç‚¹çš„æºæ–‡ä»¶æ˜ å°„ä½ç½®
    referenceï¼š{moduleName:'@angular/core',name:'ÉµÉµelementStart'}
    paramsOrFn <LiteralExpr[]>ï¼š[index,tagName,]
}
`1.`ä½¿ç”¨ElementèŠ‚ç‚¹çš„æ•°æ®åˆ›å»ºæŒ‡ä»¤creationInstruction[å†…éƒ¨è°ƒç”¨instruction(span, reference, params)]
`2.`é€’å½’å¤„ç†å­èŠ‚ç‚¹
`3.`å½“åˆ›å»ºå®ŒèŠ‚ç‚¹ creationå‡½æ•° åï¼ŒåŒæ ·è¦åˆ›å»º endElement åˆ›å»ºå‡½æ•°

`---TemplateèŠ‚ç‚¹---ã€ng-containere,ng-templateã€‘`
TemplateèŠ‚ç‚¹ï¼š{
    
}

`---text----`
å½“é‡åˆ°textèŠ‚ç‚¹æ—¶ï¼Œä¼šæ ¹æ®
```

`5.1` TemplateDefinitionBuilder 

```typescript
æ ¹æ® nodeå±æ€§ ç”Ÿæˆ åˆ›å»º/æ›´æ–°æŒ‡ä»¤é›†

åˆ›å»ºæŒ‡ä»¤é›†ï¼šcreationInstruction
æ›´æ–°æŒ‡ä»¤é›†ï¼šupdateInstructionWithAdvanceã€åŒ…æ‹¬advance[ç§»åŠ¨ä½ç½®] + updateInstructionã€‘

_constants:{constExpressions:èŠ‚ç‚¹å±æ€§ã€.constsNgComponentDef.constsã€‘,prepareStatements:}
_creationCodeFnsï¼šåˆ›å»ºåˆ›å»ºæŒ‡ä»¤é›†å‡½æ•°çš„ä»£ç tokenå­˜å‚¨ä½ç½®ã€æ ¹æ®æŒ‡ä»¤indexï¼Œtagï¼Œå±æ€§indexåˆ›å»ºElementèŠ‚ç‚¹ã€‘
_updateCodeFnsï¼šåˆ›å»ºæ›´æ–°æŒ‡ä»¤é›†å‡½æ•°çš„ä»£ç tokenå­˜å‚¨ä½ç½®ã€æ ¹æ®æŒ‡ä»¤indexï¼Œtagï¼Œå±æ€§indexæ›´æ–°ElementèŠ‚ç‚¹ã€‘
_dataIndex:æ»šåŠ¨èŠ‚ç‚¹çš„ä½ç½®ï¼Œåœ¨creationInstructionå’ŒupdateInstructionWithAdvanceæ—¶ä½¿ç”¨
			ã€ä¸ NgComponentDef.declså±æ€§ç›¸å…³ã€‘
_pureFunctionSlotsï¼šã€ä¸ NgComponentDef.varså±æ€§ç›¸å…³ã€‘
```



### NgComponentDef

`ç»„ä»¶çš„å®ä¾‹å‡½æ•°`,defineComponentçš„å‚æ•°æ˜¯ definitionMapã€‚

```typescript

const $def = defineComponent({
        type: ç»„ä»¶ç±»,
        selectors: é€‰æ‹©å™¨//
        contentQueriesï¼šå†…å®¹æŸ¥è¯¢å‡½æ•°
        viewQuery: function AppComponent_Query(rf, ctx) {
            if (rf & 1) {
                jit___viewQuery_8(_c0, 1);
            }
            if (rf & 2) {
                var _t;
                jit___queryRefresh_9((_t = jit___loadQuery_10())) &&
                    (ctx.dir = _t.first);
            }
        },
        features: ä¸NgOnChangesç”Ÿå‘½å‘¨æœŸæœ‰å…³,
        decls: è§†å›¾èŠ‚ç‚¹çš„æ•°é‡,
        vars: 5,
        consts: ã€æ•°ç»„ï¼Œå‡½æ•°[ã€‘è§£æå‡ºelementèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å±æ€§[
            [å­˜å‚¨èŠ‚ç‚¹ä¸Šçš„å±æ€§é›†åˆ{å±æ€§çš„å€¼ï¼Œå±æ€§çš„ç±»åˆ«}ï¼Œåœ¨åˆ›å»º/æ›´æ–°æ—¶ä½¿ç”¨]
            enum type{
                class = 1;
                style = 2;
                [property] | (event) = 3
				*æŒ‡ä»¤é›† = 4
            }
            æ— typeçš„å±äºå…¶ä»–ç±»å‹[#æ ‡ç­¾,'id = value', 'æŒ‡ä»¤']
        ]
        template: function AppComponent_Template(rf, ctx) {
            æ¨¡æ¿çš„æŒ‡ä»¤é›†ï¼Œåˆ†ä¸ºä¸¤ç§æ¨¡å¼
            	rf == 1ï¼šåˆ›å»º
                rf == 2ï¼šæ›´æ–°
            é€šè¿‡è°ƒç”¨å¯¹åº”æŒ‡ä»¤å‡½æ•°ï¼Œå»åˆ›å»º/æ›´æ–°èŠ‚ç‚¹ã€‚
            åˆ›å»ºelementï¼šelementStart(elementIndex, tagName,
                                   å¯¹åº”å±æ€§åœ¨constsä¸­çš„index,
                                   å¯¹åº”ç´¢å¼•åœ¨constsä¸­çš„index,)
        },
        styles: [æ ·å¼,
        ],
    })
```



#### constantPool

```typescript
å¸¸é‡æ± ï¼Œæ”¶é›†åœ¨åˆ›å»ºæŒ‡ä»¤é›†<instruction>è¿‡ç¨‹ä¸­çš„æ•°æ®

statements://æ”¶é›† å¸¸é‡ä»£ç tokenå—,æ¯”å¦‚ContentChildï¼ŒViewChildã€å› ä¸ºè¿™äº›æ•°æ®éœ€è¦å¸¸é‡ä¿å­˜ï¼ŒåŒºåˆ«äºæ¨¡æ¿çš„åŠ¨æ€æ•°æ®ã€‘
pipeDefinitions:Map(0)
nextNameIndex:1
literals:Map(1) {["content"] => FixupExpression â€¦} //æ”¶é›†[@ContentView],[@ViewChild]æ˜ å°„
literalFactories:Map(0)
isClosureCompilerEnabled:false
injectorDefinitions:Map(0)
directiveDefinitions:Map(0)
componentDefinitions:
```

#### @ContentChild()

```typescript
@ContentChild('é€‰æ‹©ç¬¦') åç§°;
å†…å®¹æŸ¥è¯¢ï¼šåœ¨è§£æè¿‡ç¨‹ä¸­ï¼Œè¢« `constantPool.literals`æ”¶é›†æ˜ å°„å…³ç³»ï¼›æœ€ç»ˆç”Ÿæˆå†…å®¹æŸ¥è¯¢å‡½æ•°çš„ä»£ç å—å­˜å…¥`definitionMap.contentQueries`

```

#### @ViewChild()

```typescript
@ViewChild('é€‰æ‹©ç¬¦') åç§°;
è§†å›¾æŸ¥è¯¢ï¼šåœ¨è§£æè¿‡ç¨‹ä¸­ï¼Œè¢« `constantPool.literals`æ”¶é›†æ˜ å°„å…³ç³»ï¼›æœ€ç»ˆç”Ÿæˆå†…å®¹æŸ¥è¯¢å‡½æ•°çš„ä»£ç å—å­˜å…¥`definitionMap.viewQuery`
```

## compileNgModuleDefs

æ¨¡å—ç¼–è¯‘

```
æ¨¡å—ä¼šç¼–è¯‘å‡ºä¸€ä¸ª injecté™æ€å‡½æ•°ã€‚
```

# ä»£ç token

#### DeclareVarStmt `varè¡¨è¾¾å¼`

```
@params name       åç§°
@params value      å€¼
@params type 
@params modifiers   
@params sourceSpan æºåœ°å€
@params leadingComments
```



#### LiteralExpr`åŸºç¡€è¡¨è¾¾å¼`

```typescript
value:å€¼
type:
sourceSpan:è®°å½•æºä½ç½®
```

#### LiteralMapExpr `å¯¹è±¡è¡¨è¾¾å¼`

```
@params entriesï¼šLiteralMapEntry[] ã€{key,value}ã€‘ 
@params type
@params sourceSpan æºåœ°å€
@params typeParams
```

#### importExpr `importå¤–éƒ¨æ–‡ä»¶`è¡¨è¾¾å¼

```
importExpr({æ¨¡å—å, å‡½æ•°åç§°}).callFn()
importExpr å¼•ç”¨ ExternalExpr æ„é€ è¡¨è¾¾å¼,å†è°ƒç”¨ çˆ¶çº§ Expression çš„åŸå‹ï¼Œæ„é€ ç‰¹å®šè¡¨è¾¾å¼ 
```

#### ExternalExpr `å¤–éƒ¨å¼•å…¥çš„è¡¨è¾¾å¼`

```
@params value:{name:'**', moduleName:'**'} å¤–éƒ¨å¼•å…¥è¡¨è¾¾å¼
@params sourceSpan æºåœ°å€
@params type
@params typeParams
```

#### InvokeFunctionExpr `å‡½æ•°è¡¨è¾¾å¼`

```
@params fn         å‡½æ•° ExternalExpr 
@params args       å‚æ•° å…¶ä»–è¡¨è¾¾å¼ã€å¯¹è±¡ï¼Œæ•°ç»„,...ã€‘
@params type  
@params sourceSpan æºåœ°å€
@params pure
```

