# RouterModule

è·¯ç”±æ¨¡å—æ³¨å…¥åˆ°åº”ç”¨ä¸­ï¼Œ

```typescript
åœ¨ã€bootstrapModuleFactoryã€‘é˜¶æ®µï¼Œå®ä¾‹åŒ–æ¨¡å—[moduleRef]åï¼Œè°ƒç”¨ApplicationInitStatus[ä¾èµ–]ï¼Œåˆå§‹åŒ–åº”ç”¨ã€‚

`ç”±äºå·²ç»æ³¨å†ŒRouterModule,å› æ­¤åˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œè·¯ç”±çš„åˆå§‹åŒ–[RouterInitializer.appInitializer]`
```



## forRoot

æ ¹æ®ä¼ å…¥çš„è·¯ç”±<route>é…ç½®ï¼Œæ•´åˆå®ˆå«ï¼Œå‘¨æœŸç­‰é€»è¾‘æ•´åˆæˆprovidersï¼Œ

ç”Ÿæˆæ–°çš„ è·¯ç”± æ¨¡å—ã€‚

```typescript
static forRoot(routes, config) {
    return {
        ngModule: RouterModule,
        providers: [
            ROUTER_PROVIDERS,
            provideRoutes(routes),
            {
                provide: ROUTER_FORROOT_GUARD,
                useFactory: provideForRootGuard,
                deps: [[Router, new Optional(), new SkipSelf()]]
            },
            { provide: ROUTER_CONFIGURATION, useValue: config ? config : {} },
            {
                provide: LocationStrategy,
                useFactory: provideLocationStrategy,
                deps: [
                    PlatformLocation, [new Inject(APP_BASE_HREF), new Optional()], ROUTER_CONFIGURATION
                ]
            },
            {
                provide: RouterScroller,
                useFactory: createRouterScroller,
                deps: [Router, ViewportScroller, ROUTER_CONFIGURATION]
            },
            {
                provide: PreloadingStrategy,
                useExisting: config && config.preloadingStrategy ? config.preloadingStrategy :
                NoPreloading
            },
            { provide: NgProbeToken, multi: true, useFactory: routerNgProbeToken },
            provideRouterInitializer(),
        ],
    };
}
`---------------------------------`
`RouterModule`:è·¯ç”±æ¨¡å—
`ROUTER_PROVIDERS`:[
     Location,       // åº”ç”¨ç¨‹åºå¯ç”¨äºä¸æµè§ˆå™¨URLäº¤äº’çš„æœåŠ¡
    { provide: UrlSerializer, useClass: DefaultUrlSerializer },  // URLè§£æ
    {
        provide: Router,                   // è·¯ç”±å™¨
        useFactory: setupRouter,
        deps: [
            ApplicationRef, UrlSerializer, ChildrenOutletContexts, Location, Injector,
            NgModuleFactoryLoader, Compiler, ROUTES, ROUTER_CONFIGURATION,
            [UrlHandlingStrategy, new Optional()], [RouteReuseStrategy, new Optional()]
        ]
    },
    ChildrenOutletContexts,        // å­˜å‚¨åµŒå¥—çš„ä¸Šä¸‹æ–‡
    { provide: ActivatedRoute, useFactory: rootRoute, deps: [Router] }, //æ¿€æ´»çš„è·¯ç”±
    { provide: NgModuleFactoryLoader, useClass: SystemJsNgModuleLoader },
    RouterPreloader,     // é¢„åŠ è½½ç¨‹åº
    NoPreloading,        // éé¢„åŠ è½½ã€é»˜è®¤ç­–ç•¥ã€‘
    PreloadAllModules,   // åŠ è½½æ‰€æœ‰çš„æ¨¡å—
    { provide: ROUTER_CONFIGURATION, useValue: Éµ0 },  // è·¯ç”±é…ç½®ğŸ‘‡config
]
`provideRoutes(routes)`  => ç”Ÿæˆä¾èµ– ã€ROUTESã€‘, 
`ROUTER_FORROOT_GUARD`       // forRootæ–¹æ³•çš„å®ˆå«âš”ï¼Œå½“è°ƒç”¨ç¬¬äºŒæ¬¡æ—¶æŠ¥é”™ã€‚
`ROUTER_CONFIGURATION`       // è·¯ç”±çš„é…ç½®ğŸ‘‡config,
`LocationStrategy`           // URLçš„ç­–ç•¥æ¨¡å¼ hash || Path[æ”¯æŒHTMl 5 çš„ history.pushState]
`RouterScroller` 
`PreloadingStrategy`         // é¢„åŠ è½½ç­–ç•¥ config.preloadingStrategy
`NgProbeToken`               // æ¢æµ‹ï¼Ÿï¼Ÿï¼Ÿ
`provideRouterInitializer()` // è·¯ç”±åˆå§‹åŒ–ä¾èµ–
     [
        RouterInitializer,       // è·¯ç”±åˆå§‹åŒ–
        {
            provide: APP_INITIALIZER,       // åº”ç”¨åˆå§‹åŒ–
            multi: true,
            useFactory: getAppInitializer,
            deps: [RouterInitializer]
        },
        { provide: ROUTER_INITIALIZER, useFactory: getBootstrapListener, deps: [RouterInitializer] },
        { provide: APP_BOOTSTRAP_LISTENER, multi: true, useExisting: ROUTER_INITIALIZER },//åº”ç”¨å¼•å¯¼ç›‘å¬
    ]
```

## forChild

```typescript
`å­è·¯ç”±åªå…³å¿ƒè·¯ç”±çš„é…ç½®`
static forChild(routes) {
        return { ngModule: RouterModule, providers: [provideRoutes(routes)] };
    }
```



### config

```typescript
interface ExtraOptions {
  enableTracing?: boolean                             // å¼€å¯åä¼šå°†å†…éƒ¨å¯¼èˆªäº‹ä»¶è®°å½•åˆ°æ§åˆ¶å°
  useHash?: boolean                              // è·¯ç”±çš„ç­–ç•¥æ¨¡å¼ hash | history
  initialNavigation?: InitialNavigation            // åˆå§‹åŒ–è·¯ç”±çš„æ—¶æœºåŠæ•ˆæœ
  errorHandler?: ErrorHandler                   // å¯¼èˆªå¤±è´¥çš„è‡ªå®šä¹‰å¤„ç†å™¨
  preloadingStrategy?: any                     // é…ç½®é¢„åŠ è½½ç­–ç•¥
  onSameUrlNavigation?: 'reload' | 'ignore'               // å¯¼èˆªåˆ°å½“å‰URLçš„å¤„ç†æ–¹å¼
  scrollPositionRestoration?: 'disabled' | 'enabled' | 'top'// é…ç½®å¯¼èˆªå›æ¥çš„æ—¶å€™æ¢å¤æ»šåŠ¨ä½ç½®
  anchorScrolling?: 'disabled' | 'enabled'
                // è®¾ç½®ä¸º â€œenabledâ€ æ—¶ï¼Œå¦‚æœ URL æœ‰ä¸€ä¸ªç‰‡æ®µï¼Œå°±æ»šåŠ¨åˆ°é”šç‚¹å…ƒç´ ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé”šå®šæ»šåŠ¨æ˜¯ç¦ç”¨çš„ã€‚
                // é”šç‚¹æ»šåŠ¨ä¸ä¼šåœ¨ â€œpopstateâ€ ä¸Šå‘ç”Ÿã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šæ¢å¤å­˜å‚¨çš„ä½ç½®æˆ–æ»šåŠ¨åˆ°é¡¶éƒ¨ã€‚
  scrollOffset?: [number, number] | (() => [number, number]) // é…ç½®å½“æ»šåŠ¨åˆ°ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè·¯ç”±å™¨ä½¿ç”¨çš„æ»šåŠ¨åç§»
  paramsInheritanceStrategy?: 'emptyOnly' | 'always'
              // å®šä¹‰è·¯ç”±å™¨å¦‚ä½•å°†å‚æ•°ã€æ•°æ®å’Œå·²è§£æçš„æ•°æ®ä»çˆ¶
              // è·¯ç”±åˆå¹¶åˆ°å­è·¯ç”±ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ˆâ€œemptyOnlyâ€ï¼‰ï¼Œä»…ç»§æ‰¿æ— è·¯å¾„æˆ–æ— ç»„ä»¶è·¯ç”±çš„çˆ¶å‚æ•°ã€‚
  malformedUriErrorHandler?: (error: URIError, urlSerializer: UrlSerializer, url: string) => UrlTree
               // ä¸€ä¸ªè‡ªå®šä¹‰çš„ URI æ ¼å¼æ— æ•ˆé”™è¯¯çš„å¤„ç†å™¨
  urlUpdateStrategy?: 'deferred' | 'eager'
         // å®šä¹‰è·¯ç”±å™¨è¦ä½•æ—¶æ›´æ–°æµè§ˆå™¨ URL
         // deferred æˆåŠŸå¯¼èˆªåæ›´æ–°
         // å¯¼èˆªå¼€å§‹æ—¶æ›´æ–°ã€é€šè¿‡æ˜¾ç¤ºå¸¦æœ‰å¤±è´¥ URL çš„é”™è¯¯æ¶ˆæ¯æ¥å¤„ç†å¯¼èˆªå¤±è´¥ã€‚ã€‘
  relativeLinkResolution?: 'legacy' | 'corrected'
       // å¯ç”¨ BUG è¡¥ä¸ï¼Œçº æ­£ç©ºè·¯å¾„ç»„ä»¶çš„ç›¸å¯¹é“¾æ¥è§£æé—®é¢˜ã€‚
}
```

## è·¯ç”±æœºåˆ¶

```typescript
`1.` åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶ï¼Œæ ¹æ®è·¯ç”±çš„é…ç½®ã€initialNavigationã€‘,ç¡®å®šè·¯ç”±åˆå§‹åŒ–æ—¶æœºã€‚
`2.` å¯åŠ¨ locationChangeListenerï¼Œç›‘å¬locationå˜åŒ–ï¼Œ
      subscribeï¼šâ‘  å°†urlè§£ææˆæ ‘
                 â‘¡ è·å–æ›´æ”¹çš„æ–¹å¼ hashchange | popstate
                 â‘¢ æ‰§è¡Œ scheduleNavigation()ã€setTimeoutå¼‚æ­¥æ‰§è¡Œã€‘
                     å¤„ç†å¯¼èˆªçš„ç‰¹æ®Šæƒ…å†µå’Œæµè§ˆå™¨çš„é—®é¢˜ã€IEï¼ŒEdgeã€‘
                     setTransition(å€¼)=> è§¦å‘navigationsçš„è®¢é˜….

```



## æ‡’åŠ è½½è·¯ç”±æœºåˆ¶

loadChildren: () => import("./ofmodules/lazy/blue/blue.module").then((*m*) => *m*.BlueModule),

```typescript
æ‡’åŠ è½½æœºåˆ¶ä¼šè§¦å‘è·¯ç”±çš„ `ApplyRedirects`[è·¯ç”±é‡å®šå‘]åŠŸèƒ½ä¸­çš„expandSegmentAgainstRoute[æ‰©å±•è·¯ç”±æ®µåŠŸèƒ½]

`0.` RouterConfigLoader.load(parentInjector, route)ã€è·¯ç”±è§£æå™¨ã€‘ã€è§£ææ¨¡å—ä¸­çš„è·¯ç”±é…ç½®ã€‘
`1.` loadChildren è§¦å‘æµè§ˆå™¨çš„importæœºåˆ¶
`2.` å¯¹æ¥æ”¶åˆ°çš„æ¨¡å—è¿›è¡Œè§£æã€this.compiler.compileModuleAsync(t)ã€‘
`3.` new NgModuleFactory$1(moduleType);ã€æ³¨å†Œæ‡’åŠ è½½çš„æ¨¡å—åŠå…¶importçš„æ¨¡å—ã€‘
`4.` from (NgModuleFactory$1ğŸ‘†)ã€fromæ˜¯ Rxçš„æ“ä½œç¬¦ã€‘
`5.` Rxçš„ä¸€ç³»åˆ—å¤æ‚è½¬æ¢ï¼Œ
`6.` const module = factory.create(parentInjector); // åˆ›å»ºæ¨¡å—
`7.` æ ¹æ® module å’Œ æ¨¡å—è‡ªèº«çš„ è·¯ç”±é…ç½®routes ç”Ÿæˆã€LoadedRouterConfigã€‘
`8.` ç»™ route æ·»åŠ  _loadedConfigã€LoadedRouterConfigã€‘
`9.` æ‹¼æ¥ parentè·¯ç”±é…ç½® å’Œ æ‡’åŠ è½½è·¯ç”±é…ç½®
`10` æ¸²æŸ“æŒ‡ä»¤
```

