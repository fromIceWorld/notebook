# æ¸²æŸ“é€»è¾‘

```typescript
å½“é‡åˆ°ç»„ä»¶æ—¶ï¼Œåœ¨å®ä¾‹åŒ–<router-outlet> æ—¶ï¼Œä¼šæ³¨å…¥ã€ChildrenOutletContexts,ViewContainerRef,ChangeDetectorRef,ComponentFactoryResolver,nameã€‘
`ChildrenOutletContexts`: æ˜¯parent outlet,æ³¨å…¥åå¯ä¸ä¸Šçº§ <router-outlet>å»ºç«‹è”ç³»
`ViewContainerRef`:å°†<router-outlet>å¯¹åº”çš„tNodeèŠ‚ç‚¹å˜ä¸ºLContainer ç±»å‹ï¼Œå¯å°†å¯¹åº”çš„è·¯ç”±component view æ’å…¥
`ChangeDetectorRef`:å˜æ›´æ£€æµ‹ä¾èµ–ï¼Œå¯åœ¨æ’å…¥å®Œå½“å‰<router-outlet>å¯¹åº”çš„component view åï¼Œæ ‡è®°æ£€æµ‹
`ComponentFactoryResolver`:è§£æå‡½æ•°ï¼Œå¯å°†componentè§£ææˆ viewï¼Œæ’å…¥åˆ° LContainer
`name`ï¼š<router-outlet> çš„æ ‡è¯†ç¬¦ï¼Œåœ¨routeä¸­é…ç½®åŒ¹é…ï¼Œé»˜è®¤æ˜¯'primary'

`æ³¨`ï¼šåœ¨å®ä¾‹åŒ–å½“å‰çš„<router-outlet>æ—¶ï¼ŒChildrenOutletContexts ä¸ºå½“å‰<router-outlet> åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œæ’å…¥åˆ° parent outletä¸­
`è§¦å‘æœºåˆ¶`ï¼š1. click äº‹ä»¶
          2. æŒ‡ä»¤å¼è§¦å‘  router.navigateByUrl(**)
`è§¦å‘æµç¨‹`ï¼š1. å°† click äº‹ä»¶ä¼ é€’çš„ url/æŒ‡ä»¤çš„urlï¼Œè§£ææˆ UrlTreeã€‚
          2. åŸºäº UrlTree é€šè¿‡ this.transition è¿›è¡Œè·¯ç”±è·³è½¬ 
          3.                                 
```

# RouterModule

è·¯ç”±æ¨¡å—æ³¨å…¥åˆ°åº”ç”¨ä¸­ï¼Œ

```typescript
åœ¨ã€bootstrapModuleFactoryã€‘é˜¶æ®µï¼Œå®ä¾‹åŒ–æ¨¡å—[moduleRef]åï¼Œè°ƒç”¨ApplicationInitStatus[ä¾èµ–]ï¼Œåˆå§‹åŒ–åº”ç”¨ã€‚

`ç”±äºå·²ç»æ³¨å†ŒRouterModule,å› æ­¤åˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œè·¯ç”±çš„åˆå§‹åŒ–[RouterInitializer.appInitializer]`
```



## forRoot

æ ¹æ®ä¼ å…¥çš„è·¯ç”±<route>é…ç½®ï¼Œæ•´åˆå®ˆå«ï¼Œå£°æ˜å‘¨æœŸç­‰é€»è¾‘æ•´åˆæˆprovidersï¼Œ

è¿”å›ä½œä¸ºimports æ•°æ®ã€‚åœ¨è§£æ importWithProviders æ—¶ï¼Œç”Ÿæˆrecord å­˜å…¥ recordsä¸­

```typescript
static forRoot(routes, config) {
    return {
        ngModule: RouterModule,
        providers: [
            ROUTER_PROVIDERS,
            provideRoutes(routes),
            {
                provide: ROUTER_FORROOT_GUARD,
                useFactory: provideForRootGuard,
                deps: [[Router, new Optional(), new SkipSelf()]]
            },
            { provide: ROUTER_CONFIGURATION, useValue: config ? config : {} },
            {
                provide: LocationStrategy,
                useFactory: provideLocationStrategy,
                deps: [
                    PlatformLocation, [new Inject(APP_BASE_HREF), new Optional()], ROUTER_CONFIGURATION
                ]
            },
            {
                provide: RouterScroller,
                useFactory: createRouterScroller,
                deps: [Router, ViewportScroller, ROUTER_CONFIGURATION]
            },
            {
                provide: PreloadingStrategy,
                useExisting: config && config.preloadingStrategy ? config.preloadingStrategy :
                NoPreloading
            },
            { provide: NgProbeToken, multi: true, useFactory: routerNgProbeToken },
            provideRouterInitializer(),
        ],
    };
}
`---------------------------------`
`RouterModule`:è·¯ç”±æ¨¡å—
`ROUTER_PROVIDERS`:[
     Location,       // åº”ç”¨ç¨‹åºå¯ç”¨äºä¸æµè§ˆå™¨URLäº¤äº’çš„æœåŠ¡,è§£æpath
    { provide: UrlSerializer, useClass: DefaultUrlSerializer },  // URLè§£æå‡½æ•°
    {
        provide: Router,                   // è·¯ç”±å™¨
        useFactory: setupRouter,
        deps: [
            ApplicationRef, UrlSerializer, ChildrenOutletContexts, Location, Injector,
            NgModuleFactoryLoader, Compiler, ROUTES, ROUTER_CONFIGURATION,
            [UrlHandlingStrategy, new Optional()], [RouteReuseStrategy, new Optional()]
        ]
    },
    ChildrenOutletContexts,        // å­˜å‚¨åµŒå¥—çš„ä¸Šä¸‹æ–‡
    { provide: ActivatedRoute, useFactory: rootRoute, deps: [Router] }, //æ¿€æ´»çš„è·¯ç”±
    { provide: NgModuleFactoryLoader, useClass: SystemJsNgModuleLoader },// åŠ è½½å™¨
    RouterPreloader,     // é¢„åŠ è½½ç¨‹åº
    NoPreloading,        // éé¢„åŠ è½½ã€é»˜è®¤ç­–ç•¥ã€‘
    PreloadAllModules,   // é¢„åŠ è½½æ‰€æœ‰çš„æ¨¡å—
    { provide: ROUTER_CONFIGURATION, useValue: Éµ0 },  // è·¯ç”±é…ç½®ğŸ‘‡config
]
`provideRoutes(routes)`  => ç”Ÿæˆä¾èµ– ã€ROUTESã€‘, 
`ROUTER_FORROOT_GUARD`       // forRootæ–¹æ³•çš„å®ˆå«âš”ï¼Œå½“è°ƒç”¨ç¬¬äºŒæ¬¡æ—¶æŠ¥é”™ã€‚
`ROUTER_CONFIGURATION`       // è·¯ç”±çš„é…ç½®ğŸ‘‡config,
`LocationStrategy`           // URLçš„ç­–ç•¥æ¨¡å¼ hash || Path[æ”¯æŒHTMl 5 çš„ history.pushState]
`RouterScroller` 
`PreloadingStrategy`         // é¢„åŠ è½½ç­–ç•¥ config.preloadingStrategy
`NgProbeToken`               // æ¢æµ‹ï¼Ÿï¼Ÿï¼Ÿ
`provideRouterInitializer()` // è·¯ç”±åˆå§‹åŒ–ä¾èµ–
     [
        RouterInitializer,       // è·¯ç”±åˆå§‹åŒ–
        {
            provide: APP_INITIALIZER,       // åº”ç”¨åˆå§‹åŒ–
            multi: true,
            useFactory: getAppInitializer,
            deps: [RouterInitializer]
        },
        { provide: ROUTER_INITIALIZER, useFactory: getBootstrapListener, deps: [RouterInitializer] },
        { provide: APP_BOOTSTRAP_LISTENER, multi: true, useExisting: ROUTER_INITIALIZER },//åº”ç”¨å¼•å¯¼ç›‘å¬
    ]
```

## forChild

```typescript
`å­è·¯ç”±åªå…³å¿ƒè·¯ç”±çš„é…ç½®`
static forChild(routes) {
        return { ngModule: RouterModule, providers: [provideRoutes(routes)] };
    }
```



### config

```typescript
interface ExtraOptions {
  enableTracing?: boolean                             // å¼€å¯åä¼šå°†å†…éƒ¨å¯¼èˆªäº‹ä»¶è®°å½•åˆ°æ§åˆ¶å°
  useHash?: boolean                              // è·¯ç”±çš„ç­–ç•¥æ¨¡å¼ hash | history
  initialNavigation?: InitialNavigation            // åˆå§‹åŒ–è·¯ç”±çš„æ—¶æœºåŠæ•ˆæœ
  errorHandler?: ErrorHandler                   // å¯¼èˆªå¤±è´¥çš„è‡ªå®šä¹‰å¤„ç†å™¨
  preloadingStrategy?: any                     // é…ç½®é¢„åŠ è½½ç­–ç•¥
  onSameUrlNavigation?: 'reload' | 'ignore'               // å¯¼èˆªåˆ°å½“å‰URLçš„å¤„ç†æ–¹å¼
  scrollPositionRestoration?: 'disabled' | 'enabled' | 'top'// é…ç½®å¯¼èˆªå›æ¥çš„æ—¶å€™æ¢å¤æ»šåŠ¨ä½ç½®
  anchorScrolling?: 'disabled' | 'enabled'
                // è®¾ç½®ä¸º â€œenabledâ€ æ—¶ï¼Œå¦‚æœ URL æœ‰ä¸€ä¸ªç‰‡æ®µï¼Œå°±æ»šåŠ¨åˆ°é”šç‚¹å…ƒç´ ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé”šå®šæ»šåŠ¨æ˜¯ç¦ç”¨çš„ã€‚
                // é”šç‚¹æ»šåŠ¨ä¸ä¼šåœ¨ â€œpopstateâ€ ä¸Šå‘ç”Ÿã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šæ¢å¤å­˜å‚¨çš„ä½ç½®æˆ–æ»šåŠ¨åˆ°é¡¶éƒ¨ã€‚
  scrollOffset?: [number, number] | (() => [number, number]) // é…ç½®å½“æ»šåŠ¨åˆ°ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè·¯ç”±å™¨ä½¿ç”¨çš„æ»šåŠ¨åç§»
  paramsInheritanceStrategy?: 'emptyOnly' | 'always'
              // å®šä¹‰è·¯ç”±å™¨å¦‚ä½•å°†å‚æ•°ã€æ•°æ®å’Œå·²è§£æçš„æ•°æ®ä»çˆ¶
              // è·¯ç”±åˆå¹¶åˆ°å­è·¯ç”±ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ˆâ€œemptyOnlyâ€ï¼‰ï¼Œä»…ç»§æ‰¿æ— è·¯å¾„æˆ–æ— ç»„ä»¶è·¯ç”±çš„çˆ¶å‚æ•°ã€‚
  malformedUriErrorHandler?: (error: URIError, urlSerializer: UrlSerializer, url: string) => UrlTree
               // ä¸€ä¸ªè‡ªå®šä¹‰çš„ URI æ ¼å¼æ— æ•ˆé”™è¯¯çš„å¤„ç†å™¨
  urlUpdateStrategy?: 'deferred' | 'eager'
         // å®šä¹‰è·¯ç”±å™¨è¦ä½•æ—¶æ›´æ–°æµè§ˆå™¨ URL
         // deferred æˆåŠŸå¯¼èˆªåæ›´æ–°
         // å¯¼èˆªå¼€å§‹æ—¶æ›´æ–°ã€é€šè¿‡æ˜¾ç¤ºå¸¦æœ‰å¤±è´¥ URL çš„é”™è¯¯æ¶ˆæ¯æ¥å¤„ç†å¯¼èˆªå¤±è´¥ã€‚ã€‘
  relativeLinkResolution?: 'legacy' | 'corrected'
       // å¯ç”¨ BUG è¡¥ä¸ï¼Œçº æ­£ç©ºè·¯å¾„ç»„ä»¶çš„ç›¸å¯¹é“¾æ¥è§£æé—®é¢˜ã€‚
}
```

## è·¯ç”±æœºåˆ¶

```typescript
`1.` åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶ï¼Œæ ¹æ®è·¯ç”±çš„é…ç½®ã€initialNavigationã€‘,ç¡®å®šè·¯ç”±åˆå§‹åŒ–æ—¶æœºã€‚
`2.` å¯åŠ¨ locationChangeListenerï¼Œç›‘å¬locationå˜åŒ–ï¼Œ
      subscribeï¼šâ‘  å°†urlè§£ææˆæ ‘
                 â‘¡ è·å–æ›´æ”¹çš„æ–¹å¼ hashchange | popstate
                 â‘¢ æ‰§è¡Œ scheduleNavigation()ã€setTimeoutå¼‚æ­¥æ‰§è¡Œã€‘
                     å¤„ç†å¯¼èˆªçš„ç‰¹æ®Šæƒ…å†µå’Œæµè§ˆå™¨çš„é—®é¢˜ã€IEï¼ŒEdgeã€‘
                     setTransition(å€¼)=> è§¦å‘navigationsçš„è®¢é˜….

```



## æ‡’åŠ è½½è·¯ç”±æœºåˆ¶

loadChildren: () => import("./ofmodules/lazy/blue/blue.module").then((*m*) => *m*.BlueModule),

```typescript
æ‡’åŠ è½½æœºåˆ¶ä¼šè§¦å‘è·¯ç”±çš„ `ApplyRedirects`[è·¯ç”±é‡å®šå‘]åŠŸèƒ½ä¸­çš„expandSegmentAgainstRoute[æ‰©å±•è·¯ç”±æ®µåŠŸèƒ½]

`0.` RouterConfigLoader.load(parentInjector, route)ã€è·¯ç”±è§£æå™¨ã€‘ã€è§£ææ¨¡å—ä¸­çš„è·¯ç”±é…ç½®ã€‘
`1.` loadChildren è§¦å‘æµè§ˆå™¨çš„importæœºåˆ¶
`2.` å¯¹æ¥æ”¶åˆ°çš„æ¨¡å—è¿›è¡Œè§£æã€this.compiler.compileModuleAsync(t)ã€‘
`3.` new NgModuleFactory$1(moduleType);ã€æ³¨å†Œæ‡’åŠ è½½çš„æ¨¡å—åŠå…¶importçš„æ¨¡å—ã€‘
`4.` from (NgModuleFactory$1ğŸ‘†)ã€fromæ˜¯ Rxçš„æ“ä½œç¬¦ã€‘
`5.` Rxçš„ä¸€ç³»åˆ—å¤æ‚è½¬æ¢ï¼Œ
`6.` const module = factory.create(parentInjector); // åˆ›å»ºæ¨¡å—
`7.` æ ¹æ® module å’Œ æ¨¡å—è‡ªèº«çš„ è·¯ç”±é…ç½®routes ç”Ÿæˆã€LoadedRouterConfigã€‘
`8.` ç»™ route æ·»åŠ  _loadedConfigã€LoadedRouterConfigã€‘
`9.` æ‹¼æ¥ parentè·¯ç”±é…ç½® å’Œ æ‡’åŠ è½½è·¯ç”±é…ç½®
`10` æ¸²æŸ“æŒ‡ä»¤
```

# Router

**è·¯ç”±å™¨**ï¼šè·¯ç”±è·³è½¬çš„ä¸­å¿ƒç‚¹ï¼Œæä¾›å¯¼èˆªå’Œ URLæ“ä½œåŠŸèƒ½çš„æœåŠ¡ã€‚

```typescript
`æ³¨å…¥çš„ä¾èµ–`ï¼š{
    rootContextsï¼Œ                  // è·¯ç”±ç³»ç»Ÿçš„æ ¹,æ˜¯ä¸Šä¸‹æ–‡ä¸­çš„é¡¶çº§ä¸Šä¸‹æ–‡ï¼Œæ‰€æœ‰çš„ router-outlet çš„ä¸Šä¸‹æ–‡éƒ½æ˜¯è¿™ä¸ªçš„å­èŠ‚ç‚¹
                                    // å¯é€šè¿‡ æ·±åº¦éå†rootContextsï¼Œæ¸²æŸ“æ‰€æœ‰çš„ <router-outlet>
}
`æ ¸å¿ƒä¿¡æ¯`:{
    currentUrlTree,                  // å½“å‰ Router çš„ URLTree é…ç½®
    rawUrlTree,                      // 
    browserUrlTree,                  // æµè§ˆå™¨çš„ URLTree 
   `routerState`,                    // è·¯ç”±ä¿¡æ¯çš„æè¿°æ•°æ®[url, query, fragment]
    transitions,                     // è·¯ç”± navigation çš„ åŸå§‹æ•°æ®ç”Ÿæˆçš„å¯è®¢é˜…çš„ BehaviorSubject
    navigations,                     // è·¯ç”±çš„ navigation è¿‡ç¨‹ï¼Œé€šè¿‡ transitionsè§¦å‘å¯¼èˆªï¼Œ
                                     // åœ¨navagation çš„ pipeä¸­æ‰§è¡Œå¯¼èˆªçš„ç”Ÿå‘½å‘¨æœŸ
}
`è·¯ç”±å‚æ•°`:{
    lastSuccessfulNavigation,          // æœ€åä¸€æ¬¡è·¯ç”±è·³è½¬æˆåŠŸçš„å¯¼èˆªä¿¡æ¯  navigation 
    currentNavigation,                 // å½“å‰å¯¼èˆªä¿¡æ¯
    navigationId,                      // navigationID, æ¯ä¸€ä¸ªnavigation éƒ½æœ‰ä¸€ä¸ªIDã€ä»0è‡ªå¢ã€‘
    lastSuccessfulId,                  // æœ€åä¸€æ¬¡navagation æˆåŠŸçš„ navigationID
    navigated,                         // æ˜¯å¦å‘ç”Ÿè¿‡å¯¼èˆªäº‹ä»¶    
}
`è¾…åŠ©å‡½æ•°`:{
    configLoader,                // åŠ è½½è·¯ç”±é…ç½®å¹¶è§£æçš„å‡½æ•°
    urlSerializer,               // urlè§£æå™¨
    location,                    // åº”ç”¨ç¨‹åºä¸æµè§ˆå™¨URL è¿›è¡Œäº¤äº’çš„å‡½æ•°
    errorHandler,                // navigation è¿‡ç¨‹ä¸­çš„é”™è¯¯å¤„ç†å‡½æ•°    
    malformedUriErrorHandler,    // `Router.parseUrl(url)` å¤„ç†å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†å‡½æ•°  
    hooks:{                      // åœ¨é¢„æ¿€æ´»å¯¼èˆªä¹‹å‰/ä¹‹åï¼Œæš‚åœå¯¼èˆªçš„ç”Ÿå‘½å‘¨æœŸ
        beforePreactivation: defaultRouterHook,
        afterPreactivation: defaultRouterHook
    },
    routeReuseStrategyï¼Œ          // è·¯ç”±ä½¿ç”¨ç­–ç•¥; å½“è·¯ç”±é…ç½®ç›¸åŒï¼Œå°±é‡ç”¨è·¯ç”±    
}
``    
`ç­–ç•¥é…ç½®`ï¼š{
    onSameUrlNavigation,          // å½“ç›¸åŒçš„URLè¿›è¡Œå¯¼èˆªæ—¶ï¼Œé»˜è®¤ 'ignore'
    paramsInheritanceStrategy,    // å¦‚ä½•åˆå¹¶paramsåŠè§£æä»parentåˆ°childçš„dataï¼Œé»˜è®¤ 'emptyOnly'  
    urlUpdateStrategy,            // browser URL çš„ æ›´æ–°æ—¶é—´ï¼Œé»˜è®¤'deferred'ï¼Œ    
    relativeLinkResolution,       // é”™è¯¯ä¿®å¤ ï¼Œæ›´æ­£ç©ºè·¯å¾„çš„è§£æ   
    isNgZoneEnabled,              // ngZone æ˜¯å¦å¯ç”¨
        
}
`äº‹ä»¶`:{
    events,                       // å½“å‰æ¨¡å—çš„ äº‹ä»¶æµ
    transitions<BehaviorSubject>, // è·¯ç”±è§¦å‘çš„åŸå§‹æ•°æ®    
}

```

## currentUrlTree

è·¯ç”±ç‰‡æ®µæ ‘ + å‚æ•°

```typescript
{
    root,             // è·¯ç”±çš„urlç‰‡æ®µã€UrlSegmentGroupã€‘ï¼Œåˆå§‹ä¸ºç©º
    queryParams,      // è·¯ç”±queryå‚æ•°   ?**=**&*=*
    fragment          // é”šç‚¹ #
}
```

### UrlSegmentGroupã€currentUrlTreeã€‘

è·¯ç”±ç‰‡æ®µ

```typescript
{
    segments:[]
    parent:
    children:{}
}
```

## *routerState

**æè¿°è·¯ç”±çš„ç›¸å…³æ•°æ®**ï¼š_root, snapshot

root æ˜¯ è·¯ç”±æ ‘

```typescript
`_root<TreeNode>`:{
    value: ActivatedRoute
    children:[{
        **: <TreeNode>
    }]
}
`snapshot<RouterStateSnapshot>`:{
    ğŸ‘‡
}
```

### RouterStateSnapshot

è·¯ç”±ç›¸å…³æ•°æ®çš„å¿«ç…§

```typescript
ä¸ routerState æ•°æ®ç±»ä¼¼, åªæ˜¯ æ•°æ®åªæ˜¯å•çº¯çš„æ•°æ®,ä¸å¯è®¢é˜…

`_root<TreeNode>`:{
    value: ActivatedRouteSnapshot,
    children: []    
}
`url`:
```

#### ActivatedRouteSnapshot

æ¿€æ´»çš„è·¯ç”±çš„å¿«ç…§

```typescript
`1.` url, params, queryParams, fragment, data æ˜¯æ™®é€šæ•°æ®.

class ActivatedRouteSnapshot {
    constructor(url, params, queryParams, 
                 fragment, data, 
                 outlet, component, routeConfig, 
                 urlSegment, lastPathIndex, resolve) {
        this.url = url;
        this.params = params;
        this.queryParams = queryParams;
        this.fragment = fragment;
        this.data = data;
        this.outlet = outlet;
        this.component = component;
        this.routeConfig = routeConfig;       // å•ä¸ªè·¯ç”±çš„é…ç½®ä¿¡æ¯
        this._urlSegment = urlSegment;        // urlTree
        this._lastPathIndex = lastPathIndex;  // 
        this._resolve = resolve;              
    }
}
```

### ActivatedRoute

å­˜æ´»çŠ¶æ€çš„Route çš„æ•°æ®

```typescript
`url, params, queryparams, fragment,data`éƒ½æ˜¯å¯è®¢é˜…ç±»å‹

@params url           // è·¯ç”±çš„URL
@params params        // å‚æ•°
@params queryParams   // urlä¸Šçš„queryå‚æ•°
@params fragment      // urlä¸Šçš„ #é”šç‚¹
@params data          // è·¯ç”±ä¸Šçš„ data æ•°æ®
@params outlet        // è·¯ç”±çš„ outlet æ ‡è®°ï¼Œé»˜è®¤ 'primary'
@params component     // è·¯ç”±å¯¹åº”çš„ç»„ä»¶
@params futureSnapshot// å¯¹åº”çš„å¿«ç…§çš„ TreeNode

class ActivatedRoute {
    constructor(url, params, queryParams, 
                 fragment, data, outlet, component, futureSnapshot) {
        this.url = url;
        this.params = params;
        this.queryParams = queryParams;
        this.fragment = fragment;
        this.data = data;
        this.outlet = outlet;
        this.component = component;
        this._futureSnapshot = futureSnapshot;
    }
}
```

#### *TreeNode

è·¯ç”±èŠ‚ç‚¹æ ‘, å°†æ‰€æœ‰çš„ã€ActivatedRouteSnapshotç±»å‹ã€‘è·¯ç”±èŠ‚ç‚¹è¿æ¥ä¸Šå°±æ˜¯ treeï¼Œæ•´ä¸ªè·¯ç”±æ ‘**_root**

TreeNodeå¼•ç”¨äº† <router-outlet> çš„å®ä¾‹ï¼Œæ¸²æŸ“æ—¶ç›´æ¥è°ƒç”¨å®ä¾‹æ¸²æŸ“

```typescript
@params value        `ActivatedRoute/ActivatedRouteSnapshot`
@params children     []   
class TreeNode {
    constructor(value, children = []) {
        this.value = value;
        this.children = children;
    }
    toString() { return `TreeNode(${this.value})`; }
}
â€‹`````tree`````````````````````````````````````````````````````````````````````````
root:{
    value:{
        url,
        params,
        queryParams,
        fragment,
        data,
        outlet,
        component,
        _futureSnapshot
    }
    children:[]
}
```



# OutletContext

å­˜å‚¨ `RouterOutlet`æœ‰å…³çš„ä¸Šä¸‹æ–‡ã€‚ä½œä¸º <router-outlet> çš„ä¸€ä¸ªæŠ½è±¡èŠ‚ç‚¹

```typescript
class OutletContext {
    constructor() {
        this.outlet = null;                            // RouterOutlet å®ä¾‹
        this.route = null;                             // ActivatedRouter
        this.resolver = null;                          // ç»„ä»¶è§£æå™¨       
        this.children = new ChildrenOutletContexts();  // å­ä¸Šä¸‹æ–‡
        this.attachRef = null;                    å½“å‰ `RouterOutlet`æŒ‚è½½çš„view
    }
}
```

## ChildrenOutletContexts

**RouterOutlet** æŒ‡ä»¤çš„ å­çº§

<router-outlet> é€šè¿‡ ChildrenOutletContexts å»ºç«‹ä¸Šä¸‹æ–‡åŠå±‚çº§å…³ç³»

```typescript
class ChildrenOutletContexts {
     constructor() {
        this.contexts = new Map();
    }
    // å­ routerOutlet è¢«åˆ›å»ºæ—¶è°ƒç”¨ï¼Œåˆ›å»ºå…³äºå­çš„ ä¸Šä¸‹æ–‡
    onChildOutletCreated(childName, outlet) {
        const context = this.getOrCreateContext(childName);
        context.outlet = outlet;
        this.contexts.set(childName, context);
    }
    // é”€æ¯å­æ—¶ï¼Œæ¸…ç©º
    onChildOutletDestroyed(childName) {
        const context = this.getContext(childName);
        if (context) {
            context.outlet = null;
        }
    }
    // å½“åœç”¨å½“å‰è·¯ç”±æ—¶ï¼Œç»„ä»¶è¢«é”€æ¯ï¼Œæ¸…ç©ºä¸Šä¸‹æ–‡
    onOutletDeactivated() {
        const contexts = this.contexts;
        this.contexts = new Map();
        return contexts;
    }
    // å½“å¯ç”¨å½“å‰è·¯ç”±çº¿æ—¶
    onOutletReAttached(contexts) { this.contexts = contexts; }
}
```

# OutletInjector

å½“åœ¨ <router-outlet>ä¸Šæ¸²æŸ“ç»„ä»¶æ—¶ï¼Œéœ€è¦ä¸ºç»„ä»¶åˆ›å»º ä¾èµ–æ³¨å…¥é“¾

```typescript
`åœ¨RouterOutletæŒ‡ä»¤çš„ activateWithå‡½æ•°ä¸­æ¸²æŸ“åˆ›å»ºç»„ä»¶`
@params route          // activatedRoute
@params childContexts  // childContexts
@params parent         // this.location.injector ã€ViewContainerRefçš„ injectorã€‘

class OutletInjector {
    constructor(route, childContexts, parent) {
        this.route = route;
        this.childContexts = childContexts;
        this.parent = parent;
    }
    get(token, notFoundValue) {
        if (token === ActivatedRoute) {
            return this.route;
        }
        if (token === ChildrenOutletContexts) {
            return this.childContexts;
        }
        return this.parent.get(token, notFoundValue);
    }
}
`ä¸º router-outletæ¸²æŸ“çš„ç»„ä»¶viewåˆ›å»º ä¾èµ–é“¾ï¼Œå°†ç»„ä»¶çš„ä¾èµ–æŒ‡å‘ä¾èµ–æ ‘`
```



```typescript
å½“é‡åˆ°ç»„ä»¶æ—¶ï¼Œåœ¨å®ä¾‹åŒ–<router-outlet> æ—¶ï¼Œä¼šæ³¨å…¥ã€ChildrenOutletContexts,ViewContainerRef,ChangeDetectorRef,ComponentFactoryResolver,nameã€‘
`ChildrenOutletContexts`: æ˜¯parent outlet,æ³¨å…¥åå¯ä¸ä¸Šçº§ <router-outlet>å»ºç«‹è”ç³»
`ViewContainerRef`:å°†<router-outlet>å¯¹åº”çš„tNodeèŠ‚ç‚¹å˜ä¸ºLContainer ç±»å‹ï¼Œå¯å°†å¯¹åº”çš„è·¯ç”±component view æ’å…¥
`ChangeDetectorRef`:å˜æ›´æ£€æµ‹ä¾èµ–ï¼Œå¯åœ¨æ’å…¥å®Œå½“å‰<router-outlet>å¯¹åº”çš„component view åï¼Œæ ‡è®°æ£€æµ‹
`ComponentFactoryResolver`:è§£æå‡½æ•°ï¼Œå¯å°†componentè§£ææˆ viewï¼Œæ’å…¥åˆ° LContainer
`name`ï¼š<router-outlet> çš„æ ‡è¯†ç¬¦ï¼Œåœ¨routeä¸­é…ç½®åŒ¹é…ï¼Œé»˜è®¤æ˜¯'primary'

`æ³¨`ï¼šåœ¨å®ä¾‹åŒ–å½“å‰çš„<router-outlet>æ—¶ï¼ŒChildrenOutletContexts ä¸ºå½“å‰<router-outlet> åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œæ’å…¥åˆ° parent outletä¸­
`è§¦å‘`ï¼š
```





# RouterOutlet

ç»„ä»¶ <router-outlet>ï¼Œæ³¨å…¥äº† **ViewContainerRef** ï¼Œå› æ­¤ä¼šå¼ºåˆ¶åœ¨lviewä¸Šä¼šç”Ÿæˆ**LContainer** ç±»å‹çš„èŠ‚ç‚¹

ã€parentContexts.onChildOutletCreated(this.name, this)ã€‘å°†å½“å‰ç»„ä»¶æ·»åŠ åˆ°<router-outlet> æ ‘ä¸­ï¼Œåç»­ç›´æ¥è°ƒç”¨**æ ‘**é—´æ¥æ¿€æ´» <router-outlet>

```typescript
@params parentContexts  ÉµÉµdirectiveInject(ChildrenOutletContexts)    
@params location        ÉµÉµdirectiveInject(ViewContainerRef)          
@params resolver        ÉµÉµdirectiveInject(ComponentFactoryResolver)  
@params name            ÉµÉµinjectAttribute('name')                    
@params changeDetector  ÉµÉµdirectiveInject(ChangeDetectorRef)        

`ViewContainerRef`ï¼šåœ¨ViewContainerRef.mdä¸Šæœ‰æ³¨é‡Š
`ChildrenOutletContexts`:åˆ›å»ºå½“å‰ RouterOutlet çš„ä¸Šä¸‹æ–‡, åˆå§‹æ˜¯rootContext
`resolver`ï¼šç»„ä»¶è§£æå™¨ï¼Œç”¨äºè§£æç»„ä»¶ç”Ÿæˆdef
`name`ï¼šRouterOutlet å¯¹åº”çš„ åç§°ï¼Œå±äºä¸€ç§å…·åæ’æ§½
`changeDetector`:ç”¨äºæ‰§è¡Œè„æ£€æŸ¥çš„å‡½æ•°

class RouterOutlet {
    constructor(parentContexts, location, resolver, name, changeDetector) {
        this.parentContexts = parentContexts;
        this.location = location;
        this.resolver = resolver;
        this.changeDetector = changeDetector;
        this.activated = null;
        this._activatedRoute = null;
        this.activateEvents = new EventEmitter();
        this.deactivateEvents = new EventEmitter();
        this.name = name || PRIMARY_OUTLET;
        parentContexts.onChildOutletCreated(this.name, this);
    }
}
`åŸºç¡€çŠ¶æ€`ï¼š{
    `parentContexts`ï¼š{
        contexts<Map>: {
            this.name: {
                outlet: this,
                route: null,
                resolver: null,
                children: new ChildrenOutletContexts(),
                attachRef:  null  
            }
        },
            
    }
    `activated`ï¼šæ¿€æ´»çš„ componentRef
    `_activatedRoute`ï¼šæ¿€æ´»çš„è·¯ç”± ã€ActivateRouteã€‘,
    `name`ï¼šå½“å‰ç»„ä»¶çš„ åç§°ï¼Œç”¨äºæ’å…¥routeç»„ä»¶    
}
`emitçš„äº‹ä»¶`:{
    activateEvents,  // æ¿€æ´»å½“å‰ç»„ä»¶æ—¶çš„äº‹ä»¶
    deactivateEvents // å–æ¶ˆæ¿€æ´»å½“å‰ç»„ä»¶æ—¶çš„äº‹ä»¶   
}
```

## è·¯ç”±æ¸²æŸ“

è·¯ç”±é…ç½®ä¸Šçš„ç»„ä»¶æ¸²æŸ“åˆ°<router-outlet>ä¸Šã€‚å¯¹åº”çš„ lviewä¸Šçš„èŠ‚ç‚¹å˜ä¸º**LContainer**ç±»å‹

è§£ærouteä¸Šçš„componentï¼Œä½¿ç”¨componentFactory.create()åˆ›å»ºå¯¹åº”çš„ **componentRef** 

åˆ›å»ºçš„è¿™ä¸ª **componentRef**ä¸ åº”ç”¨åˆå§‹åŒ–**AppComponent**æ—¶ä¸€æ ·ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„lviewæ ‘ã€‚

`è·¯ç”±é€»è¾‘`ï¼šå°±æ˜¯ä¸Šé¢çš„é€»è¾‘ç”Ÿæˆæ¸²æŸ“åŠæ§åˆ¶å„å±‚çº§è·¯ç”±



**æ—¶æœº**ï¼šåœ¨ transition è¿‡ç¨‹ä¸­ï¼Œç»è¿‡å„ä¸ªè·¯ç”±å®ˆå«âš”ï¼Œæ‰§è¡Œ **activateRoutes**ï¼Œè¿›è¡Œè·¯ç”±æ¸²æŸ“

```typescript
@params rootContexts         // Router çš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯æ ¹
@params routeReuseStrategy   // è·¯ç”±é‡ç”¨ç­–ç•¥
@params forwardEvent         // è§¦å‘router.eventçš„å‡½æ•°

`å®ä¾‹åŒ– ActivateRoutesï¼Œç­æ´»éè·¯ç”±çº¿ä¸Šçš„æ—§è·¯ç”±; æ¿€æ´»è·¯ç”±çº¿ä¸Šçš„æ–°è·¯ç”±`
t.targetRouterStateï¼š ç›®æ ‡è·¯ç”±çº¿ã€‚ // ç”±TreeNodeè¿æ¥ç»„æˆçš„è·¯ç”±æ ‘
t.currentRouterStateï¼šå½“å‰è·¯ç”±çº¿   //

const activateRoutes =  
    (rootContexts, routeReuseStrategy, forwardEvent) => map((
    t => {
        new ActivateRoutes(
            routeReuseStrategy,
            t.targetRouterState,
            t.currentRouterState, 
            forwardEvent
        ).activate(rootContexts);
        return t;
    }))
```

# è·¯ç”±è¿è½¬æµç¨‹

transition.next è§¦å‘ navigationçš„ pipeã€‚

```typescript
`transition`:{
      id: 0,
      currentUrlTree: this.currentUrlTree,
      currentRawUrl: this.currentUrlTree,
      extractedUrl: this.urlHandlingStrategy.extract(this.currentUrlTree),
      urlAfterRedirects: this.urlHandlingStrategy.extract(this.currentUrlTree),
      rawUrl: this.currentUrlTree,
      extras: {},
      resolve: null,
      reject: null,
      promise: Promise.resolve(true),
      source: "imperative",
      restoredState: null,
      currentSnapshot: this.routerState.snapshot,
      targetSnapshot: null,
      currentRouterState: this.routerState,
      targetRouterState: null,
      guards: { canActivateChecks: [], canDeactivateChecks: [] },
      guardsResult: null,
}
`è§¦å‘`ï¼š[
    1: <a [router-link]="['/index']"></a>  // clickäº‹ä»¶
    2ï¼šç›´æ¥æ“ä½œtransition
]
     
    
```

## clickäº‹ä»¶

clickäº‹ä»¶è§¦å‘ è·¯ç”±

```typescript
`æš‚æ—¶ä¸è€ƒè™‘é…ç½®æ•°æ®`
å½“ç‚¹å‡» æŒ‰é’® è¿›è¡Œè·¯ç”±è·³è½¬æ—¶ï¼Œéœ€è¦æ ¹æ®currentUrlTree, routerState.root, commandsï¼Œç”Ÿæˆæ–°çš„tree
`1.` ä¼šå°† [router-link] å¯¹åº”çš„å‚æ•°ä¸ currentUrlTreeï¼ŒrouterState.root å¤„ç†æˆæ–°çš„ UrlTreeğŸ‘‡
     ä½œä¸º transitionä¸­çš„ rawUrl å±æ€§
`2.` è°ƒç”¨ router.navigateByUrl(this.urlTree, extras) æ ¹æ®urltree ä¸é…ç½®ä¿¡æ¯è¿›è¡Œå¯¼èˆª  
     è§¦å‘ `this.setTransition(**)` è¿›å…¥pipeä¸­
```

æ–°æ ‘çš„ç”Ÿæˆ

ActivateRouteï¼ŒcurrentUrlTreeï¼Œcommandsï¼Œqueryparamsï¼Œfragment

```typescript
`1.` æ ¹æ® commands ç¡®å®š url å«ä¹‰ã€urlç‰‡æ®µï¼Œæ˜¯å¦ç»å¯¹å®šä½ï¼Œ'..'çš„ä¸ªæ•°ã€‘
`2.` æ ¹æ® å½“å‰ commands ç”Ÿæˆ segmentGroup
`3.` å¯¹æ¯” `old`segmentGroup å’Œ `new`segmentGroup ç”Ÿæˆæ–°çš„ tree
```

### UrlTree

```typescript
`è·¯ç”±ç‰‡æ®µæ ‘å’Œå‚æ•°çš„é›†åˆ`
{
    root: UrlSegmentGroup // è·¯ç”±urlç‰‡æ®µæ ‘ğŸ‘‡
    queryParams:{}        // queryå¯¹è±¡
    fragment:             // é”šç‚¹#
}
```

#### UrlSegmentGroup

```typescript
`<a [routerLink]="['/index/go']">go</a>` ç”Ÿæˆçš„UrlSegmentGroup
children çš„ key å€¼ å¯¹åº”çš„æ˜¯ <router-outlet> ä¸Šçš„nameå±æ€§ï¼Œé»˜è®¤æ˜¯ `primary`
{
    segments:[]
    parent:
    children:{
        primary:{
            segments:[
                {
                    path:'index',
                    parameters:{}
                },
                {
                    path:'go',
                    parameters:{}
                }
            ],
            parent:,
            children:    
        }
    }
}
```

##### UrlSegment

```typescript
`è·¯ç”±æ®µï¼ŒåŒ…å«å½“å‰æ®µçš„ path`
class UrlSegment {
    constructor(
    path, 
    parameters) {
        this.path = path;
        this.parameters = parameters;
    }
    get parameterMap() {
        if (!this._parameterMap) {
            this._parameterMap = convertToParamMap(this.parameters);
        }
        return this._parameterMap;
    }
    toString() {
        return serializePath(this);
    }
}
```



1. è¿‡æ»¤æ‰ id = 0çš„ transitionï¼Œå› ä¸ºæ˜¯åˆå§‹çš„ transition
2. ä» rawUrl ä¸­æå–å‡º url ã€extractedUrlã€‘
3. è§¦å‘ **NavigationStart**ç”Ÿå‘½å‘¨æœŸ
4. æ£€æŸ¥è·¯ç”±çš„é‡å®šå‘ï¼Œå°†é‡å®šå‘çš„urlã€urlAfterRedirectsã€‘åº”ç”¨åˆ° transition 
5. æ ¹æ® url åŠè·¯ç”±é…ç½® ç”Ÿæˆ **RouterStateSnapshot** æ”¾å…¥transitionä¸­, å…¶ä¸­åŒ…æ‹¬ ç”Ÿæˆçš„ tree
6. å¤„ç† **é¢„è§£æ**é€»è¾‘
7. **GuardsCheckStart**  ç”Ÿå‘½å‘¨æœŸ
8. è·å– route ä¸Šçš„ å®ˆå«âš”
9. æ£€æŸ¥å®ˆå« **canActivateChecks**ï¼Œ**canDeactivateChecks**
10. **GuardsCheckEnd**  ç”Ÿå‘½å‘¨æœŸ
11. è¿‡æ»¤æ‰ guardsResult = false çš„ transition
12. **ResolveStart** ç”Ÿå‘½å‘¨æœŸ
13. **ResolveEnd** ç”Ÿå‘½å‘¨æœŸ
14. é¢„æ¿€æ´»å **this.hook.afterPreactivation**
15. ç”Ÿæˆ **targetSnapshot**
16. æ¿€æ´»ç»„ä»¶**activateRoutes**

