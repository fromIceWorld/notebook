**è·¯ç”±çš„æ ¸å¿ƒ**ï¼šRouterï¼Œä¸ºactiveçš„URL ç®¡ç†ç»„ä»¶çš„æ˜¾ç¤ºï¼Œå¯¼èˆª

**è·¯ç”±å˜åŒ–æ¥æº**ï¼š

```typescript
`1.` ç‚¹å‡»æ ‡ç­¾å¯¼èˆªï¼š router-link= '****'
`2.` åˆå§‹åŒ–æ—¶ï¼ŒredirectToï¼ŒæŒ‡å‘å…¶ä»–è·¯ç”±
`3.` å‘½ä»¤å¯¼èˆª: Router.navigate(...) 
`4.` å¤–éƒ¨å¯¼èˆªï¼Œæµè§ˆå™¨çš„å‰è¿›åé€€      
                                                      
```

**è·¯ç”±ç»„ä»¶æ¸²æŸ“ä½ç½®**

```typescript
route é…ç½® outlet:'***'
<router-outlet name="**"></router-outlet>

å¯é…ç½®ç›¸åŒçš„pathï¼Œoutletä¸åŒï¼Œè¿™æ ·ä¼šåŒæ—¶æ¸²æŸ“ä¸¤ä¸ªç»„ä»¶
ä¸é…ç½®outletï¼Œé»˜è®¤æ˜¯ primary
```

**è·¯ç”±å™¨äº‹ä»¶**ï¼š

```typescript
`NavigationStart`ï¼š      å¯¼èˆªå¼€å§‹æ—¶è§¦å‘çš„äº‹ä»¶
    `RouteConfigLoadStart`:  Router æƒ°æ€§åŠ è½½è·¯ç”±é…ç½®å‰è§¦å‘çš„äº‹ä»¶
    `RouteConfigLoadEnd`ï¼š   æŸä¸ªè·¯ç”±å·²ç»æƒ°æ€§åŠ è½½å®Œæ¯•æ—¶è§¦å‘çš„äº‹ä»¶
`RoutesRecognized` ï¼š    å½“è·¯ç”±å™¨è§£æäº† URLï¼Œè€Œä¸”è·¯ç”±å·²ç»è¯†åˆ«å®Œæ¯•æ—¶è§¦å‘çš„äº‹ä»¶ã€‚

--------âš”è·¯ç”±å®ˆå«âš”-------------------------------------------------
`GuardsCheckStart`ï¼š     å½“è·¯ç”±å™¨å¼€å§‹è¿›å…¥è·¯ç”±å®ˆå«é˜¶æ®µæ—¶è§¦å‘çš„äº‹ä»¶ã€‚
    `ChildActivationStart`ï¼š å½“è·¯ç”±å™¨å¼€å§‹æ¿€æ´»æŸè·¯ç”±çš„å­è·¯ç”±æ—¶è§¦å‘çš„äº‹ä»¶
    `ActivationStart`:       å½“è·¯ç”±å™¨å¼€å§‹æ¿€æ´»æŸä¸ªè·¯ç”±æ—¶è§¦å‘çš„äº‹ä»¶ã€‚ 
`GuardsCheckEnd`:        å½“è·¯ç”±å™¨æˆåŠŸç»“æŸäº†è·¯ç”±å®ˆå«é˜¶æ®µæ—¶è§¦å‘çš„äº‹ä»¶ã€‚

---------è§£æè·¯ç”±------------------------------------------------
`ResolveStart`:          å½“è·¯ç”±å™¨å¼€å§‹è·¯ç”±è§£æé˜¶æ®µæ—¶è§¦å‘çš„äº‹ä»¶ã€‚
`ResolveEnd`:            å½“è·¯ç”±å™¨çš„è·¯ç”±è§£æé˜¶æ®µæˆåŠŸå®Œæˆæ—¶è§¦å‘çš„äº‹ä»¶


    `ChildActivationEnd`:    å½“è·¯ç”±å™¨æˆåŠŸæ¿€æ´»æŸè·¯ç”±çš„å­è·¯ç”±æ—¶è§¦å‘çš„äº‹ä»¶ã€‚
`ActivationEnd`:         å½“è·¯ç”±å™¨æˆåŠŸæ¿€æ´»äº†æŸä¸ªè·¯ç”±æ—¶è§¦å‘çš„äº‹ä»¶ã€‚
`NavigationEnd`:         å½“å¯¼èˆªæˆåŠŸç»“æŸæ—¶è§¦å‘çš„äº‹ä»¶ã€‚

`NavigationCancel`       å½“å¯¼èˆªè¢«å–æ¶ˆæ—¶è§¦å‘çš„äº‹ä»¶ã€‚ è¿™å¯èƒ½åœ¨å¯¼èˆªæœŸé—´æŸä¸ªè·¯ç”±å®ˆå«è¿”å›äº† false æˆ–è¿”å›äº† 
                             UrlTree ä»¥è¿›è¡Œé‡å®šå‘æ—¶å‘ç”Ÿã€‚
`NavigationError`        å½“å¯¼èˆªç”±äºéé¢„æœŸçš„é”™è¯¯è€Œå¤±è´¥æ—¶è§¦å‘çš„äº‹ä»¶
`Scroll`                 ç”¨æ¥è¡¨ç¤ºæ»šåŠ¨çš„äº‹ä»¶ã€‚
```

**è·¯ç”±æµç¨‹**

```typescript
`1.` ä»¥ Routerä¸ºæ ¸å¿ƒï¼Œæ‰€æœ‰æ›´æ”¹è·¯ç”±çš„æ“ä½œéƒ½é€šè¿‡æ”¹å˜ Router.transitionå±æ€§ï¼Œ
     ç»è¿‡pipeè½¬æ¢
`2.` Routerä¸­transitionä¸ºè·¯ç”±é…ç½®ï¼Œnavagationä¸ºç®¡é“, eventä¸ºäº‹ä»¶ä¸­å¿ƒï¼Œæ‰€æœ‰å“åº”è·¯ç”±çš„å˜æ¢éƒ½è®¢é˜…event
		`è®¢é˜…è€…`: RouterLinkWithHref
                 RouterLinkActive      // è·¯ç”±æ¿€æ´»çš„æ ·å¼
                 RouterPreloader       // è·¯ç”±é¢„åŠ è½½
                 RouterScroller        // æ»šè½®
                 enableTracingé…ç½®ï¼š    // å½“å¯ç”¨æ—¶ï¼Œconsoleä¼šæ‰“å°ç”Ÿå‘½å‘¨æœŸ
        
`3.` å½“æ›´æ”¹ transition æ—¶ï¼Œnavagation å¯¹ transition è¿›è¡Œpipe è½¬æ¢ï¼Œè½¬æ¢è¿‡ç¨‹ä¸­æ‰§è¡ŒğŸ‘†çš„ç”Ÿå‘½å‘¨æœŸ,
     åœ¨ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸ emit ä¸åŒçš„ å®ä¾‹ï¼Œè®¢é˜…è€…æ ¹æ®å®ä¾‹çš„ç±»å‹ï¼Œä½œå‡ºå›åº”ã€‚

```

1. **å‘½ä»¤å¼å¯¼èˆª**

   router.navigate(...)

   router.navigateByUrl(...)

   ```typescript
   @params commands  æ•°ç»„
   @params extras    é…ç½®
   
   navigate(commands, extras = { skipLocationChange: false }) {
           validateCommands(commands);  // éªŒè¯å‚æ•°æœ‰æ•ˆæ€§
           return this.navigateByUrl(this.createUrlTree(commands, extras), extras);
   }
   
   navigateByUrl(url, extras = {
           skipLocationChange: false
       }) {
           const urlTree = isUrlTree(url) ? url : this.parseUrl(url);
           const mergedTree = this.urlHandlingStrategy.merge(urlTree, this.rawUrlTree);
           return this.scheduleNavigation(mergedTree, 'imperative', null, extras);
       }
   ----------------------------------
   navigate ä¹Ÿæ˜¯è°ƒç”¨çš„ navigateByUrlï¼š
   ```

   

   

2. **æ ‡ç­¾å¯¼èˆª**

   RouterLink è®¾ç½® @HostBinding å±æ€§ï¼Œè®¾ç½® host çš„ clickäº‹ä»¶å¦‚ä¸‹

   ```typescript
   ğŸ‘‡ RouterLink ç±»
   ```

   

3. **URL å˜åŒ–å¯¼èˆª**

# RouterModule

è·¯ç”±æ¨¡å—æ³¨å…¥åˆ°åº”ç”¨ä¸­ï¼Œ

```typescript
åœ¨ã€bootstrapModuleFactoryã€‘é˜¶æ®µï¼Œå®ä¾‹åŒ–æ¨¡å—[moduleRef]åï¼Œè°ƒç”¨ApplicationInitStatus[ä¾èµ–]ï¼Œåˆå§‹åŒ–åº”ç”¨ã€‚

`ç”±äºå·²ç»æ³¨å†ŒRouterModule,å› æ­¤åˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œè·¯ç”±çš„åˆå§‹åŒ–[RouterInitializer.appInitializer]`
```



## forRoot

æ ¹æ®ä¼ å…¥çš„è·¯ç”±<route>é…ç½®ï¼Œæ•´åˆå®ˆå«ï¼Œå‘¨æœŸç­‰é€»è¾‘æ•´åˆæˆprovidersï¼Œ

ç”Ÿæˆæ–°çš„ è·¯ç”± æ¨¡å—ã€‚

```typescript
static forRoot(routes, config) {
    return {
        ngModule: RouterModule,
        providers: [
            ROUTER_PROVIDERS,
            provideRoutes(routes),
            {
                provide: ROUTER_FORROOT_GUARD,
                useFactory: provideForRootGuard,
                deps: [[Router, new Optional(), new SkipSelf()]]
            },
            { provide: ROUTER_CONFIGURATION, useValue: config ? config : {} },
            {
                provide: LocationStrategy,
                useFactory: provideLocationStrategy,
                deps: [
                    PlatformLocation, [new Inject(APP_BASE_HREF), new Optional()], ROUTER_CONFIGURATION
                ]
            },
            {
                provide: RouterScroller,
                useFactory: createRouterScroller,
                deps: [Router, ViewportScroller, ROUTER_CONFIGURATION]
            },
            {
                provide: PreloadingStrategy,
                useExisting: config && config.preloadingStrategy ? config.preloadingStrategy :
                NoPreloading
            },
            { provide: NgProbeToken, multi: true, useFactory: routerNgProbeToken },
            provideRouterInitializer(),
        ],
    };
}
`---------------------------------`
`RouterModule`:è·¯ç”±æ¨¡å—
`ROUTER_PROVIDERS`:[
     Location,       // åº”ç”¨ç¨‹åºå¯ç”¨äºä¸æµè§ˆå™¨URLäº¤äº’çš„æœåŠ¡
    { provide: UrlSerializer, useClass: DefaultUrlSerializer },  // URLè§£æ
    {
        provide: Router,                   // è·¯ç”±å™¨
        useFactory: setupRouter,
        deps: [
            ApplicationRef, UrlSerializer, ChildrenOutletContexts, Location, Injector,
            NgModuleFactoryLoader, Compiler, ROUTES, ROUTER_CONFIGURATION,
            [UrlHandlingStrategy, new Optional()], [RouteReuseStrategy, new Optional()]
        ]
    },
    ChildrenOutletContexts,        // å­˜å‚¨åµŒå¥—çš„ä¸Šä¸‹æ–‡
    { provide: ActivatedRoute, useFactory: rootRoute, deps: [Router] }, //æ¿€æ´»çš„è·¯ç”±
    { provide: NgModuleFactoryLoader, useClass: SystemJsNgModuleLoader },
    RouterPreloader,     // é¢„åŠ è½½ç¨‹åº
    NoPreloading,        // éé¢„åŠ è½½ã€é»˜è®¤ç­–ç•¥ã€‘
    PreloadAllModules,   // åŠ è½½æ‰€æœ‰çš„æ¨¡å—
    { provide: ROUTER_CONFIGURATION, useValue: Éµ0 },  // è·¯ç”±é…ç½®ğŸ‘‡config
]
`provideRoutes(routes)`  => ç”Ÿæˆä¾èµ– ã€ROUTESã€‘, 
`ROUTER_FORROOT_GUARD`       // forRootæ–¹æ³•çš„å®ˆå«âš”ï¼Œå½“è°ƒç”¨ç¬¬äºŒæ¬¡æ—¶æŠ¥é”™ã€‚
`ROUTER_CONFIGURATION`       // è·¯ç”±çš„å‚æ•°ä¿¡æ¯ğŸ‘‡config,
`LocationStrategy`           // URLçš„ç­–ç•¥æ¨¡å¼ hash || Path[æ”¯æŒHTMl 5 çš„ history.pushState]
`RouterScroller` 
`PreloadingStrategy`         // é¢„åŠ è½½ç­–ç•¥ config.preloadingStrategy
`NgProbeToken`               // æ¢æµ‹ï¼Ÿï¼Ÿï¼Ÿ
`provideRouterInitializer()` // è·¯ç”±åˆå§‹åŒ–ä¾èµ–
     [
        RouterInitializer,       // è·¯ç”±åˆå§‹åŒ–
        {
            provide: APP_INITIALIZER,       // åº”ç”¨åˆå§‹åŒ–
            multi: true,
            useFactory: getAppInitializer,
            deps: [RouterInitializer]
        },
        { provide: ROUTER_INITIALIZER, useFactory: getBootstrapListener, 
                   deps: [RouterInitializer] },
        { provide: APP_BOOTSTRAP_LISTENER, multi: true, useExisting: ROUTER_INITIALIZER },//åº”ç”¨å¼•å¯¼ç›‘å¬
    ]
```

## forChild

```typescript
`å­è·¯ç”±åªå…³å¿ƒè·¯ç”±çš„é…ç½®`
static forChild(routes) {
        return { ngModule: RouterModule, providers: [provideRoutes(routes)] };
    }
```

### config

```typescript
interface ExtraOptions {
  enableTracing?: boolean                             // å¼€å¯åä¼šå°†å†…éƒ¨å¯¼èˆªäº‹ä»¶è®°å½•åˆ°æ§åˆ¶å°
  useHash?: boolean                              // è·¯ç”±çš„ç­–ç•¥æ¨¡å¼ hash | history
  initialNavigation?: InitialNavigation            // åˆå§‹åŒ–è·¯ç”±çš„æ—¶æœºåŠæ•ˆæœ
  errorHandler?: ErrorHandler                   // å¯¼èˆªå¤±è´¥çš„è‡ªå®šä¹‰å¤„ç†å™¨
  preloadingStrategy?: any                     // é…ç½®é¢„åŠ è½½ç­–ç•¥
  onSameUrlNavigation?: 'reload' | 'ignore'               // å¯¼èˆªåˆ°å½“å‰URLçš„å¤„ç†æ–¹å¼
  scrollPositionRestoration?: 'disabled' | 'enabled' | 'top'// é…ç½®å¯¼èˆªå›æ¥çš„æ—¶å€™æ¢å¤æ»šåŠ¨ä½ç½®
  anchorScrolling?: 'disabled' | 'enabled'
                // è®¾ç½®ä¸º â€œenabledâ€ æ—¶ï¼Œå¦‚æœ URL æœ‰ä¸€ä¸ªç‰‡æ®µï¼Œå°±æ»šåŠ¨åˆ°é”šç‚¹å…ƒç´ ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé”šå®šæ»šåŠ¨æ˜¯ç¦ç”¨çš„ã€‚
                // é”šç‚¹æ»šåŠ¨ä¸ä¼šåœ¨ â€œpopstateâ€ ä¸Šå‘ç”Ÿã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šæ¢å¤å­˜å‚¨çš„ä½ç½®æˆ–æ»šåŠ¨åˆ°é¡¶éƒ¨ã€‚
  scrollOffset?: [number, number] | (() => [number, number]) // é…ç½®å½“æ»šåŠ¨åˆ°ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè·¯ç”±å™¨ä½¿ç”¨çš„æ»šåŠ¨åç§»
  paramsInheritanceStrategy?: 'emptyOnly' | 'always'
              // å®šä¹‰è·¯ç”±å™¨å¦‚ä½•å°†å‚æ•°ã€æ•°æ®å’Œå·²è§£æçš„æ•°æ®ä»çˆ¶
              // è·¯ç”±åˆå¹¶åˆ°å­è·¯ç”±ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ˆâ€œemptyOnlyâ€ï¼‰ï¼Œä»…ç»§æ‰¿æ— è·¯å¾„æˆ–æ— ç»„ä»¶è·¯ç”±çš„çˆ¶å‚æ•°ã€‚
  malformedUriErrorHandler?: (error: URIError, urlSerializer: UrlSerializer, url: string) => UrlTree
               // ä¸€ä¸ªè‡ªå®šä¹‰çš„ URI æ ¼å¼æ— æ•ˆé”™è¯¯çš„å¤„ç†å™¨
  urlUpdateStrategy?: 'deferred' | 'eager'
         // å®šä¹‰è·¯ç”±å™¨è¦ä½•æ—¶æ›´æ–°æµè§ˆå™¨ URL
         // deferred æˆåŠŸå¯¼èˆªåæ›´æ–°
         // å¯¼èˆªå¼€å§‹æ—¶æ›´æ–°ã€é€šè¿‡æ˜¾ç¤ºå¸¦æœ‰å¤±è´¥ URL çš„é”™è¯¯æ¶ˆæ¯æ¥å¤„ç†å¯¼èˆªå¤±è´¥ã€‚ã€‘
  relativeLinkResolution?: 'legacy' | 'corrected'
       // å¯ç”¨ BUG è¡¥ä¸ï¼Œçº æ­£ç©ºè·¯å¾„ç»„ä»¶çš„ç›¸å¯¹é“¾æ¥è§£æé—®é¢˜ã€‚
}
```

## è·¯ç”±æœºåˆ¶

```typescript
`1.` åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶ï¼Œè·å–ä¾èµ–[ApplicationInitStatus],æ‰§è¡Œåˆå§‹åŒ–ã€‚ 
    providers:[
        {
            provider:ApplicationInitStatus,
            deps:[APP_INITIALIZER]
        },
        {
            provide: APP_INITIALIZER,
            multi: true,
            useFactory: getAppInitializer,
            deps: [RouterInitializer]
        }
    ]
    æ‰§è¡Œçš„æ˜¯`getAppInitializer`,å°†RouterInitializeræ”¾å…¥ApplicationInitStatuså®ä¾‹çš„appInitsä¸­,
         å¾ªç¯æ‰§è¡Œåˆå§‹åŒ–å‡½æ•°appInitsã€‚ 'è·¯ç”±åˆå§‹åŒ–'æ˜¯è¿è¡Œçš„ã€RouterInitializer.appInitializerã€‘:
            `1.` å®ä¾‹åŒ– Router
            `2.` è·å–é…ç½®ä¿¡æ¯ï¼š ROUTER_CONFIGURATION[provider]
            `3.` æ ¹æ®é…ç½®ä¿¡æ¯ ç¡®è®¤ è·¯ç”±çš„æ‰§è¡Œæ—¶æœº
            
`2.` setUpLocationChangeListener å‡½æ•° å¯åŠ¨ locationChangeListenerï¼Œç›‘å¬locationå˜åŒ–ï¼Œ
      subscribeï¼šâ‘  è§£ææ›´æ”¹åçš„ urlï¼Œ å°†urlè§£ææˆæ ‘
                 â‘¡ å¦‚æœå¯ä»¥æ‰§è¡Œæ›´æ”¹ï¼Œ å°±æ‰§è¡ŒğŸ‘‡
                 â‘¢ æ‰§è¡Œ scheduleNavigation()ã€setTimeoutå¼‚æ­¥æ‰§è¡Œã€‘
                     å¤„ç†å¯¼èˆªçš„ç‰¹æ®Šæƒ…å†µå’Œæµè§ˆå™¨çš„é—®é¢˜ã€IEï¼ŒEdgeã€‘
                     setTransition(å€¼)=> è§¦å‘navigationsçš„è®¢é˜….

```

## Router

```typescript
`åˆå§‹åŒ–`
const router = {
    this.currentUrlTree = createEmptyUrlTree();ğŸ‘‡
    this.rawUrlTree = this.currentUrlTree;
    this.browserUrlTree = this.currentUrlTree;
    this.routerState = createEmptyState(this.currentUrlTree, this.rootComponentType);

    events = new Subject();
    transitions:new BehaviorSubject({}),  // è¿‡æ¸¡ç”¨æ•°æ®
    navigations:                          // transitions.pipe(....), å®é™…è·¯ç”±
} 
```

### createEmptyUrlTree

åˆå§‹æ—¶ï¼Œæ˜¯ç©ºçš„ UrlTree

```typescript
new UrlTree(new UrlSegmentGroup([], {}), {}, null);
{
    root:{
        segments:[], 
        children:{}
    },
    queryParams:{},
    fragment:null    
}
```

## createEmptyState

åˆå§‹æ—¶åˆ›å»ºç©ºçš„ State

```typescript
@params urlTree
@params rootComponent
function createEmptyState(urlTree, rootComponent) {
    const snapshot = createEmptyStateSnapshot(urlTree, rootComponent);
    const emptyUrl = new BehaviorSubject([new UrlSegment('', {})]);
    const emptyParams = new BehaviorSubject({});
    const emptyData = new BehaviorSubject({});
    const emptyQueryParams = new BehaviorSubject({});
    const fragment = new BehaviorSubject('');
    const activated = new ActivatedRoute(emptyUrl, emptyParams, 
                                         emptyQueryParams, fragment, 
                                         emptyData, PRIMARY_OUTLET, 
                                         rootComponent, snapshot.root);
    activated.snapshot = snapshot.root;
    return new RouterState(new TreeNode(activated, []), snapshot);
}
`1.` åˆ›å»º EmptyState å¯¹åº”çš„å¿«ç…§ snapshot
`2.` emptyUrlï¼ŒemptyParamsï¼ŒemptyDataï¼ŒemptyQueryParamsï¼Œfragment
      é…ç½®ä¸ºObservable
`3.` activated å­˜å‚¨æ¿€æ´»è·¯ç”±ä¸Šçš„ç»„ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼Œ    
`4.` activated.snapshot = snapshot.root
`5.` æ ¹æ® å¿«ç…§åŠ æ¿€æ´»çš„è·¯ç”±ä¿¡æ¯ï¼Œå®ä¾‹åŒ– RouterState
```

### createEmptyStateSnapshot

```typescript
function createEmptyStateSnapshot(urlTree, rootComponent) {
    const emptyParams = {};
    const emptyData = {};
    const emptyQueryParams = {};
    const fragment = '';
    const activated = new ActivatedRouteSnapshot([],
                                                 emptyParams,
                                                 emptyQueryParams, 
                                                 fragment, 
                                                 emptyData, 
                                                 PRIMARY_OUTLET,
                                                 rootComponent, 
                                                 null, 
                                                 urlTree.root, 
                                                 -1, 
                                                 {});
    return new RouterStateSnapshot('', new TreeNode(activated, []));
}
```

#### ActivatedRouteSnapshot

```typescript
æ¿€æ´»çš„è·¯ç”±ä¿¡æ¯çš„å¿«ç…§ï¼š`æ¯”æ¿€æ´»çš„è·¯ç”±ä¿¡æ¯å¤šäº†ä¸¤ä¸ªå­—æ®µ`
ActivatedRouteSnapshot{
    	this.url = url;
        this.params = params;
        this.queryParams = queryParams;
        this.fragment = fragment;
        this.data = data;
        this.outlet = outlet;
        this.component = component;
        this.routeConfig = routeConfig;
        this._urlSegment = urlSegment;
        this._lastPathIndex = lastPathIndex;
        this._resolve = resolve;
}
```

#### TreeNode

```typescript
class TreeNode {
    constructor(value, children) {
        this.value = value;
        this.children = children;
    }
    toString() {
        return `TreeNode(${this.value})`;
    }
}
```

#### RouterStateSnapshot

```typescript
class RouterStateSnapshot extends Tree {
    /** @internal */
    constructor(
    /** The url from which this snapshot was created */
    url, root) {
        super(root);
        this.url = url;
        setRouterState(this, root);
    }
    toString() {
        return serializeNode(this._root);
    }
}
function setRouterState(state, node) {
    node.value._routerState = state;
    node.children.forEach(c => setRouterState(state, c));
}
```

#### RouterState

```typescript
class RouterState extends Tree {
    /** @internal */
    constructor(root, 
    /** The current snapshot of the router state */
    snapshot) {
        super(root);
        this.snapshot = snapshot;
        setRouterState(this, root);
    }
    toString() {
        return this.snapshot.toString();
    }
}
```



## å¯¼èˆªæœºåˆ¶

```

```



## ROUTER_DIRECTIVES

*RouterModule* ä¸­å®šä¹‰çš„ç»„ä»¶

### RouterOutlet

```typescript
é€‰æ‹©å™¨ï¼š`<router-outlet></router-outlet>`
    
    
```

### RouterLink

```typescript
templateï¼š`<a [routerLink]="['/user/bob']" [state]="{tracingId: 123}">
          link to user component
        </a>`
æŒ‡ä»¤ï¼š routerLinkã€‚
propå±æ€§ï¼š
        routerLink              // è·¯ç”±æŒ‡å‘é…ç½®
        queryParams             // è·¯ç”±æŸ¥è¯¢å‚æ•°
        fragment                // å“ˆå¸Œç‰‡æ®µ(#)
        state                   // å¼€å‘äººå‘˜å®šä¹‰çš„çŠ¶æ€
        relativeTo              // ç›¸å¯¹è·¯ç”±ï¼Œæœªæä¾›å°±é»˜è®¤ route
                                     å…è®¸ä»å½“å‰æ¿€æ´»çš„è·¯ç”±è¿›è¡Œç›¸å¯¹å¯¼èˆªã€‚
        replaceUrl              // å¯¼èˆªæ—¶ï¼Œä¸è¦æŠŠå½“å‰çŠ¶æ€è®°å…¥å†å²
        preserveFragment        // åœ¨åç»­å¯¼èˆªæ—¶ä¿ç•™ # ç‰‡æ®µ
        skipLocationChange      // å¯¼èˆªæ—¶ä¸è¦æŠŠæ–°çŠ¶æ€è®°å…¥å†å²
        queryParamsHandling     // å¦‚ä½•å¤„ç†è·¯ç”±å™¨è¿æ¥ä¸­çš„æŸ¥è¯¢å‚æ•°ğŸ‘‡
                                        
HostListenerå±æ€§ï¼š
        onClickï¼šğŸ‘‡
æµç¨‹ï¼š â‘  é€šè¿‡ @HostBinding å±æ€§è£…é¥°å™¨ï¼Œä¿®æ”¹ å®¿ä¸»çš„ 'click' äº‹ä»¶ï¼Œä½¿æŒ‡å‘ RouterLinkçš„ onClick å‡½æ•°ã€‚
      â‘¡ è§£æ URL[routerLink çš„ è¾“å…¥å±æ€§] ç”Ÿæˆ UrlTreeï¼Œ
      â‘¢ è°ƒç”¨ router çš„ navigateByUrl å‡½æ•°ï¼Œè°ƒç”¨ scheduleNavigation æ›´æ”¹ transitionï¼Œ è§¦å‘             transition æ›´æ”¹äº‹ä»¶ï¼Œç»§è€Œè§¦å‘navagations äº‹ä»¶ï¼Œèµ° navagationsçš„ pipe
         
```

#### queryParamsHandling

```typescript
`preserve`:
// from /view1?page=1 to/view2?page=1
this.router.navigate(['/view2'], { queryParams: { page: 2 },  queryParamsHandling: "preserve"
});
`merge`
// from /view1?page=1 to/view2?page=1&otherKey=2
this.router.navigate(['/view2'], { queryParams: { otherKey: 2 },  queryParamsHandling: "merge"
});
```

#### onClick

```typescript
onClick() {
        const extras = {
            skipLocationChange: attrBoolValue(this.skipLocationChange),
            replaceUrl: attrBoolValue(this.replaceUrl),
            state: this.state,
        };
        this.router.navigateByUrl(this.urlTree, extras);
        return true;
    }
get urlTree() {
        return this.router.createUrlTree(this.commands, {
            // If the `relativeTo` input is not defined, 
            // we want to use `this.route` by default.
            // Otherwise, we should use the value provided by the user in the input.
            relativeTo: this.relativeTo !== undefined ? this.relativeTo : this.route,
            queryParams: this.queryParams,
            fragment: this.fragment,
            queryParamsHandling: this.queryParamsHandling,
            preserveFragment: attrBoolValue(this.preserveFragment),
        });
    }
`1.` è®¾ç½®é…ç½®å±æ€§extras
`2.` this.urlTree ä¼šå°†ä¼ å…¥çš„ routerLinkçš„å€¼æ ¹æ®ğŸ‘†propå±æ€§é…ç½®ï¼Œ
                                            relativeTo
                                            this.currentUrlTree
     è§£æå‡ºæ–°å¯¼èˆªä¿¡æ¯ UrlTree
     .... å®¹é”™ä¿¡æ¯ï¼Œ// ä¾‹å¦‚ urlç›¸åŒå¦‚ä½•å¤„ç†
                  //      è®°å½•å‰ä¸€ä¸ªæˆåŠŸçš„å¯¼èˆªï¼Œå¦‚æœé”™è¯¯ï¼Œå¯å›é€€ä¿¡æ¯
`3.` `this.setTransition(æ–°çš„å¯¼èˆªä¿¡æ¯)` 
     ä¼šèµ°ç”Ÿå‘½å‘¨æœŸå¹¶é€šçŸ¥è®¢é˜…è€…
```

## createUrlTree

```typescript
@params route            // åŸºå‡†è·¯ç”±,é»˜è®¤æ˜¯this.router
@params currentUrlTree   // å½“å‰ UrlTree
@params commands         // è·³è½¬ç›®æ ‡çš„ urlæ•°æ®
@params queryParams      // æŸ¥è¯¢å‚æ•°
@params fragment         // é”šç‚¹ #

`1.` æ ¹æ® commands è§£ææˆ navagationğŸ‘‡
`2.` æ ¹æ® navagation åŠ route  è§£æå‡º startingPositionã€ è·¯ç”±ç‰‡æ®µï¼Œç´¢å¼•ï¼ŒprocessChildren ã€‘
`3.` æ ¹æ® startingPosition åŠ æ˜¯å¦è§£æ childrenï¼Œæ›´æ–° segmentGroup
`4.` æ ¹æ® startingPosition.segmentGroup, 
         segmentGroup, 
         currentUrlTreeï¼Œ
         queryParams,fragment
     ç”Ÿæˆ treeğŸ‘‡
```

### navagation

```typescript
return navagation = {
	numberOfDoubleDots:0,          //  '..'çš„æ•°é‡
    isAbsolute:false,        //  æ˜¯å¦æ˜¯ç»å¯¹è·¯å¾„
    commands:['*','*',...]         //  è·¯ç”±æ®µ
}
------------------`ç¤ºä¾‹å¦‚ğŸ‘‡`----------------------------------------              
'../a/b':  {
    numberOfDoubleDots:1,          //  '..'çš„æ•°é‡
    isAbsolute:false,        //  æ˜¯å¦æ˜¯ç»å¯¹è·¯å¾„
    commands:['a','b']   
}
'/b':  {
    numberOfDoubleDots:0,          //  '..'çš„æ•°é‡
    isAbsolute:true,        //  æ˜¯å¦æ˜¯ç»å¯¹è·¯å¾„
    commands:['b']   
}
```

#### findStartingPosition

```typescript
function findStartingPosition(nav, tree, route) {
    if (nav.isAbsolute) {
        return new Position(tree.root, true, 0);
    }
    if (route.snapshot._lastPathIndex === -1) {
        const segmentGroup = route.snapshot._urlSegment;
        // Pathless ActivatedRoute has _lastPathIndex === -1 but should not process children
        // see issue #26224, #13011, #35687
        // However, if the ActivatedRoute is the root we should process children like above.
        const processChildren = segmentGroup === tree.root;
        return new Position(segmentGroup, processChildren, 0);
    }
    const modifier = isMatrixParams(nav.commands[0]) ? 0 : 1;
    const index = route.snapshot._lastPathIndex + modifier;
    return createPositionApplyingDoubleDots(route.snapshot._urlSegment, index, nav.numberOfDoubleDots);
}
----------------------------------------------------------
`1.`æ ¹æ® navagation çš„å±æ€§ï¼Œè§£æ routeï¼Œè·å– è·¯ç”±ç‰‡æ®µä¿¡æ¯ã€‚ 
```

### updateSegmentGroupChildren

æ ¹æ® è·å–çš„è·¯ç”±ç‰‡æ®µä¿¡æ¯åŠ ç›®çš„è·¯ç”±ä¿¡æ¯ï¼Œæ›´æ–° ç‰‡æ®µä¿¡æ¯çš„ children

```
æ ¹æ®è·¯ç”±çš„ç‰‡æ®µä¿¡æ¯åŠ ç›®çš„è·¯ç”±ä¿¡æ¯ï¼Œ
```

### updateSegmentGroup

```typescript
`1.` å°† commands ä¸ segmentGroup matchï¼Œ è§£æå‡ºpathIndexï¼ŒcommandIndex
`2.` æ ¹æ®åŒ¹é…æ®µï¼Œå°† childæ‹¼æ¥åˆ° segmentGroupä¸Šã€‚
```



### tree

```
urlTree.root, oldSegmentGroup, newSegmentGroup;

åœ¨å½“å‰æ®µä¸Šï¼Œå‘ä¸‹æ‰¾oldï¼Œé‡åˆ°oldï¼Œç”¨newæ›¿æ¢old
```



## UrlTree

æ ¹æ®å½“å‰çš„ UrlSegmentGroup åŠ  å¯¼èˆªç›®æ ‡ navagationç”Ÿæˆçš„ç›®æ ‡ UrlSegmentGroup ï¼Œ

#### UrlSegmentGroup

è·¯å¾„ç»„

```typescript
class UrlSegmentGroup {
    constructor(
    /** The URL segments of this group. See `UrlSegment` for more information */
    segments, 
    /** The list of children of this group */
    children) {
        this.segments = segments;
        this.children = children;
        /** The parent node in the url tree */
        this.parent = null;
        forEach(children, (v, k) => v.parent = this);
    }
    /** Whether the segment has child segments */
    hasChildren() {
        return this.numberOfChildren > 0;
    }
    /** Number of child segments */
    get numberOfChildren() {
        return Object.keys(this.children).length;
    }
    /** @docsNotRequired */
    toString() {
        return serializePaths(this);
    }
}
`segments`ï¼šè·¯ç”±æ®µ
`children`ï¼šå­è·¯ç”±ç»„ UrlSegmentGroup
```

##### RootSegment

```typescript
new UrlSegmentGroup([], {});
```



### RouterLinkWithHref



### RouterLinkActive

æ£€æŸ¥è·¯ç”±æ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œä»è€Œè®¾ç½®classï¼Œæˆ–å…¶ä»–å±æ€§

```typescript
`1.` <a routerLink="/user/bob" routerLinkActive="class1 class2">Bob</a>
`2.` <a routerLink="/user/bob" routerLinkActive #rla="routerLinkActive">
      Bob {{ rla.isActive ? '(already open)' : ''}}
     </a>
`3.` <div routerLinkActive="active-link" [routerLinkActiveOptions]="{exact: true}">
        <a routerLink="/user/jim">Jim</a>
        <a routerLink="/user/bob">Bob</a>
     </div>

```

### ÉµEmptyOutletComponent

å½“è·¯ç”±å™¨ ä¸ºç©ºæ—¶ï¼Œéœ€è¦è·¯ç”±å™¨å‡ºå£

```typescript
è·¯ç”±é…ç½®å¦‚ä¸‹ï¼š{
    path: 'parent', 
    outlet: 'nav', 
    children: [...]
}
```

## Router

æä¾›è§†å›¾å¯¼èˆªåŠURLæ“ä½œ

```

```



## æ‡’åŠ è½½è·¯ç”±æœºåˆ¶

loadChildren: () => import("./ofmodules/lazy/blue/blue.module").then((*m*) => *m*.BlueModule),

```typescript
æ‡’åŠ è½½æœºåˆ¶ä¼šè§¦å‘è·¯ç”±çš„ `ApplyRedirects`[è·¯ç”±é‡å®šå‘]åŠŸèƒ½ä¸­çš„expandSegmentAgainstRoute[æ‰©å±•è·¯ç”±æ®µåŠŸèƒ½]

`0.` RouterConfigLoader.load(parentInjector, route)ã€è·¯ç”±è§£æå™¨ã€‘ã€è§£ææ¨¡å—ä¸­çš„è·¯ç”±é…ç½®ã€‘
`1.` loadChildren è§¦å‘æµè§ˆå™¨çš„importæœºåˆ¶
`2.` å¯¹æ¥æ”¶åˆ°çš„æ¨¡å—è¿›è¡Œè§£æã€this.compiler.compileModuleAsync(t)ã€‘
`3.` new NgModuleFactory$1(moduleType);ã€æ³¨å†Œæ‡’åŠ è½½çš„æ¨¡å—åŠå…¶importçš„æ¨¡å—ã€‘
`4.` from (NgModuleFactory$1ğŸ‘†)ã€fromæ˜¯ Rxçš„æ“ä½œç¬¦ã€‘
`5.` Rxçš„ä¸€ç³»åˆ—å¤æ‚è½¬æ¢ï¼Œ
`6.` const module = factory.create(parentInjector); // åˆ›å»ºæ¨¡å—
`7.` æ ¹æ® module å’Œ æ¨¡å—è‡ªèº«çš„ è·¯ç”±é…ç½®routes ç”Ÿæˆã€LoadedRouterConfigã€‘
`8.` ç»™ route æ·»åŠ  _loadedConfigã€LoadedRouterConfigã€‘
`9.` æ‹¼æ¥ parentè·¯ç”±é…ç½® å’Œ æ‡’åŠ è½½è·¯ç”±é…ç½®
`10` æ¸²æŸ“æŒ‡ä»¤
```

## RX

### switchMap

å°†æ¯ä¸ªæºå€¼æŠ•å°„æˆObservableï¼Œè¯¥Observable ä¼šåˆå¹¶åˆ°è¾“å‡ºObservableä¸­ï¼Œå¹¶ä¸”åªå‘å‡ºæœ€æ–°æŠ•å°„çš„ Observableçš„å€¼



### tap

å’Œ do ç±»ä¼¼ï¼Œçªƒå¬å·²è¢«è®¢é˜…çš„ Observable

```

```

## URL è§£æå™¨

 { provide: UrlSerializer, useClass: DefaultUrlSerializer },

```typescript
urlï¼š` 
      /inbox/33(popup:compose)
      /inbox/33;open=true/messages/44`

class DefaultUrlSerializer {
    /** å°† url è§£ææˆ UrlTree */
    parse(url) {
       `1.` è§£æ root '/'                // æ˜¯å¦æ˜¯ '/'å¼€å¤´
             return new  UrlSegmentGroup()
        
       `2.` è§£æ queryParams '?' '&'     // '?name=12&age=13'
       `3.` è§£æ Fragment '#'            // '#middle' 
       `4.` return new UrlTree(url, queryParams, Fragment)
      
    }
    /** å°† UrlTree è§£ææˆ url */
    serialize(tree) {
        `1.` å°† UrlSegmentGroup ç»„åˆæ‹¼è£…
        `2.` æ‹¼æ¥ queryParams
        `3.` æ‹¼æ¥ é”šç‚¹
    }
}
con
```

## RouterConfigLoader

è·¯ç”±é…ç½®çš„ loaderè§£æå™¨

```

```

