# React18

æ„å»º **å¿«é€Ÿå“åº”** çš„å¤§å‹webåº”ç”¨ç¨‹åº

éš¾ç‚¹ï¼š

1. é‡åˆ°å¤§è®¡ç®—é‡çš„æ“ä½œæˆ–è€…è®¾å¤‡æ€§èƒ½ä¸è¶³ä½¿é¡µé¢æ‰å¸§ï¼Œå¯¼è‡´å¡é¡¿ã€‚**CPUç“¶é¢ˆ**
2. å‘é€ç½‘ç»œè¯·æ±‚åï¼Œç”±äºéœ€è¦ç­‰å¾…æ•°æ®è¿”å›æ‰èƒ½è¿›ä¸€æ­¥æ“ä½œå¯¼è‡´ä¸èƒ½å¿«é€Ÿå“åº”ã€‚ **IOç“¶é¢ˆ**

## Reactäº‹ä»¶ç³»ç»Ÿ

***ä¸åŒçš„æµè§ˆå™¨ï¼Œäº‹ä»¶å­˜åœ¨ä¸åŒçš„å…¼å®¹æ€§ï¼Œreactè¯•å›¾å®ç°ä¸€ä¸ªå…¼å®¹æ‰€æœ‰æµè§ˆå™¨çš„æ¡†æ¶***

ä½¿ç”¨åˆæˆäº‹ä»¶ä»£æ›¿åŸç”Ÿäº‹ä»¶ã€‚

- åŸç”Ÿäº‹ä»¶ï¼šaddEventListenerç»‘å®šçš„äº‹ä»¶
- åˆæˆäº‹ä»¶ï¼šé€šè¿‡JSXç»‘å®šçš„äº‹ä»¶ã€‚ä¾‹ï¼šonClick={()=>handle()}

ä½¿ç”¨äº‹ä»¶å§”æ‰˜æœºåˆ¶,ä¸å°†äº‹ä»¶ç»‘å®šåˆ°DOMï¼Œè€Œæ˜¯åœ¨ rootæ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œç»Ÿä¸€å¤„ç†ã€‚

å½“è§¦å‘äº‹ä»¶æ—¶ï¼Œæ‹¿åˆ°targetèŠ‚ç‚¹ï¼Œæ”¶é›†è§¦å‘èŠ‚ç‚¹->rootèŠ‚ç‚¹ä¸Šçš„æ•è·äº‹ä»¶å’Œå†’æ³¡äº‹ä»¶ï¼ŒæŒ‰é¡ºåºè§¦å‘ã€‚

- å¯¹äºclick,keydown...äº‹ä»¶ã€‚å¯¹**å†’æ³¡å’Œæ•è·è¿›è¡Œäº‹ä»¶ç»‘å®š**
- å¯¹äºscroll,load,playç­‰ä¸å†’æ³¡çš„äº‹ä»¶ã€‚å¯¹**æ•è·é˜¶æ®µè¿›è¡Œç»‘å®š**

## Scheduleï¼ˆè°ƒåº¦å™¨ï¼‰ğŸš¦

### Laneä¼˜å…ˆçº§

31ä½äºŒè¿›åˆ¶è¡¨ç¤ºä¼˜å…ˆçº§

### Reactäº‹ä»¶ä¼˜å…ˆçº§

```jsx
// ç¦»æ•£äº‹ä»¶ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ï¼šç‚¹å‡»äº‹ä»¶ï¼Œinputè¾“å…¥ç­‰è§¦å‘çš„æ›´æ–°ä»»åŠ¡ï¼Œä¼˜å…ˆçº§æœ€é«˜
export const DiscreteEventPriority: EventPriority = SyncLane;
// è¿ç»­äº‹ä»¶ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ï¼šæ»šåŠ¨äº‹ä»¶ï¼Œæ‹–åŠ¨äº‹ä»¶ç­‰ï¼Œè¿ç»­è§¦å‘çš„äº‹ä»¶
export const ContinuousEventPriority: EventPriority = InputContinuousLane;
// é»˜è®¤äº‹ä»¶ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ï¼šsetTimeoutè§¦å‘çš„æ›´æ–°ä»»åŠ¡
export const DefaultEventPriority: EventPriority = DefaultLane;
// é—²ç½®äº‹ä»¶ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§æœ€ä½
export const IdleEventPriority: EventPriority = IdleLane;
```

### Scheduleä¼˜å…ˆçº§

```jsx
export const NoPriority = 0; // æ²¡æœ‰ä»»ä½•ä¼˜å…ˆçº§
export const ImmediatePriority = 1; // ç«‹å³æ‰§è¡Œçš„ä¼˜å…ˆçº§ï¼Œçº§åˆ«æœ€é«˜
export const UserBlockingPriority = 2; // ç”¨æˆ·é˜»å¡çº§åˆ«çš„ä¼˜å…ˆçº§
export const NormalPriority = 3; // æ­£å¸¸çš„ä¼˜å…ˆçº§
export const LowPriority = 4; // è¾ƒä½çš„ä¼˜å…ˆçº§
export const IdlePriority = 5; // ä¼˜å…ˆçº§æœ€ä½ï¼Œè¡¨ç¤ºä»»åŠ¡å¯ä»¥é—²ç½®
```

### Scheduleçš„ä»»åŠ¡è¿‡æœŸæ—¶é—´

ä¸åŒçš„ä¼˜å…ˆçº§å¯¹åº”ç€ä¸åŒçš„ä»»åŠ¡è¿‡æœŸæ—¶é—´ã€‚

```jsx
var IMMEDIATE_PRIORITY_TIMEOUT = -1;
var USER_BLOCKING_PRIORITY_TIMEOUT = 250;
var NORMAL_PRIORITY_TIMEOUT = 5000;
var LOW_PRIORITY_TIMEOUT = 10000;
// Never times out
var IDLE_PRIORITY_TIMEOUT = maxSigned31BitInt;
```

### Scheduleè®¡ç®—è¿‡æœŸæ—¶é—´ 

scheduleCallbackå‡½æ•°

```jsx
var timeout;
switch (priorityLevel) {
case ImmediatePriority:
  timeout = IMMEDIATE_PRIORITY_TIMEOUT;
  break;
case UserBlockingPriority:
  timeout = USER_BLOCKING_PRIORITY_TIMEOUT;
  break;
case IdlePriority:
  timeout = IDLE_PRIORITY_TIMEOUT;
  break;
case LowPriority:
  timeout = LOW_PRIORITY_TIMEOUT;
  break;
case NormalPriority:
default:
  timeout = NORMAL_PRIORITY_TIMEOUT;
  break;
}
// startTimeå¯æš‚ä¸”è®¤ä¸ºæ˜¯å½“å‰æ—¶é—´
var expirationTime = startTime + timeout;
```

### Schedule ä¸­çš„ task

```jsx
var newTask = {
	id: taskIdCounter++,
    callback,       // ä»»åŠ¡å‡½æ•°
	priorityLevel,  // ä»»åŠ¡ä¼˜å…ˆçº§
    startTime,      // ä»»åŠ¡å¼€å§‹æ—¶é—´
    expirationTime, // ä»»åŠ¡è¿‡æœŸæ—¶é—´
    sortIndexï¼š-1   // å°é¡¶å †ä¸­çš„æ’åºä¾æ®
}
```

### Scheduleçš„åŠŸèƒ½

1. å¤šä¸ªä»»åŠ¡çš„ç®¡ç†        ã€ ä»»åŠ¡ä¼˜å…ˆçº§ã€‘
2. å•ä¸ªä»»åŠ¡çš„æ—¶é—´æ§åˆ¶ã€æ—¶é—´ç‰‡ã€‘

ä»»åŠ¡ä¼˜å…ˆçº§è®©ä»»åŠ¡æŒ‰ç…§è‡ªèº«çš„ç´§æ€¥ç¨‹åº¦æ’åºï¼Œè®©é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æœ€å…ˆè¢«æ‰§è¡Œã€‚

æ—¶é—´ç‰‡è§„å®šå•ä¸ªä»»åŠ¡åœ¨è¿™ä¸€å¸§å†…æœ€å¤§çš„æ‰§è¡Œæ—¶é—´ï¼Œä»»åŠ¡ä¸€æ—¦æ‰§è¡Œæ—¶é—´è¶…è¿‡æ—¶é—´ç‰‡ï¼Œåˆ™ä¼šè¢«æ‰“æ–­ï¼Œæœ‰èŠ‚åˆ¶çš„æ‰§è¡Œä»»åŠ¡ï¼Œè¿™æ ·å¯ä»¥ä¿è¯é¡µé¢ä¸ä¼šå› ä¸ºä»»åŠ¡è¿ç»­æ‰§è¡Œçš„æ—¶é—´é•¿äº§ç”Ÿå¡é¡¿ã€‚

è¡ç”Ÿä¸¤å¤§åŠŸèƒ½ï¼š***ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†***ã€ ***æ—¶é—´ç‰‡ä¸‹ä»»åŠ¡çš„ä¸­æ–­å’Œæ¢å¤***ã€‚

### ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

å°†ä»»åŠ¡åˆ†ä¸ºä¸¤ç§ï¼š

- `æœªè¿‡æœŸä»»åŠ¡`ï¼štimeQueue
- `å·²è¿‡æœŸä»»åŠ¡`ï¼štaskQueue

#### å¦‚ä½•åŒºåˆ†ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Ÿ

ä»»åŠ¡çš„å¼€å§‹æ—¶é—´(startTime)å’Œå½“å‰æ—¶é—´(currentTime)æ¯”è¾ƒã€‚

startTime > currentTimeï¼šæœªè¿‡æœŸï¼Œæ”¾å…¥timeQueue;

startTime < currentï¼šè¿‡æœŸï¼Œæ”¾å…¥taskQueue;

#### ä¸åŒé˜Ÿåˆ—ä¸­ä»»åŠ¡å¦‚ä½•æ’åºï¼Ÿ

- taskQueueï¼šæ ¹æ®è¿‡æœŸæ—¶é—´(expiration)æ’åº,è¿‡æœŸæ—¶é—´è¶Šæ—©ï¼Œè¶Šç´§æ€¥ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚
- timeQueueï¼šæ ¹æ®ä»»åŠ¡å¼€å§‹æ—¶é—´(startTime)æ’åºï¼Œå¼€å§‹æ—¶é—´è¶Šæ—©ï¼Œä»»åŠ¡æ‰§è¡Œä¼˜å…ˆçº§è¶Šé«˜ã€‚

taskQueueæ˜¯å°é¡¶å †ã€‚æ–°ä»»åŠ¡å…¥æ ˆæ—¶ï¼Œé‡æ–°æ’åˆ—ã€‚

### å•ä¸ªä»»åŠ¡çš„ä¸­æ–­ä»¥åŠæ¢å¤ğŸš§

#### åˆ¤æ–­å•ä¸ªä»»åŠ¡çš„å®ŒæˆçŠ¶æ€

å¦‚æœä»»åŠ¡å‡½æ•°è¿”å›å€¼æ˜¯å‡½æ•°ï¼Œå°±è¯´æ˜å½“å‰ä»»åŠ¡æœªå®Œæˆï¼Œéœ€è¦ç»§ç»­è°ƒç”¨ä»»åŠ¡å‡½æ•°ï¼Œå¦åˆ™å°±æ˜¯å®Œæˆã€‚

```jsx
ä»taskQueueä¸­è·å–taskï¼Œæ‰§è¡Œcallbackï¼Œå¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°fnå°±å°†fnèµ‹å€¼ç»™callback,ä»¥å¾…åç»­æ‰§è¡Œã€‚
å¦‚æœè¿”å›çš„ä¸æ˜¯å‡½æ•°ï¼Œå°±è¯æ˜taskæ‰§è¡Œå®Œæ¯•ï¼Œå°†taskä»taskQueueä¸­æ¨å‡ºã€‚
```

#### å–æ¶ˆè°ƒåº¦

```
å°†å½“å‰callbackè®¾ä¸ºnullã€‚workLoopè®¤ä¸ºå½“å‰taskå·²ç»æ‰§è¡Œå®Œæˆï¼Œå°±ä¼šç§»å‡ºtaskQueueã€‚
```

### MessageChannel

ç”Ÿæˆæµè§ˆå™¨ä¸­çš„ä¸€ä¸ªå®ä»»åŠ¡ï¼Œå°†èµ„æºäº¤ç»™æµè§ˆå™¨æ›´æ–°é¡µé¢,æµè§ˆå™¨æ›´æ–°é¡µé¢åå†æ‰§è¡ŒScheduleä¸­çš„ä»»åŠ¡

#### ä¸ºä»€ä¹ˆä½¿ç”¨MessageChannel

1. ä¸ç”¨å¾®ä»»åŠ¡æ˜¯å› ä¸ºå¾®ä»»åŠ¡å°†åœ¨é¡µé¢æ›´æ–°å®Œæˆå‰å…¨éƒ¨æ‰§è¡Œï¼Œæ— æ³•å°†èµ„æºé‡Šæ”¾ç»™æµè§ˆå™¨
2. ä¸ç”¨setTimeoutæ˜¯å› ä¸ºsetTimeoutåˆ›å»ºçš„ä»»åŠ¡ä¼šè‡³å°‘å»¶è¿Ÿ4msï¼Œè€ŒMessageChannelæ€»ä¼šåœ¨setTimeoutä¹‹å‰æ‰§è¡Œï¼Œä¸”æ‰§è¡Œæ¶ˆè€—çš„æ—¶é—´å°äºsetTimeoutã€‚
3. ä¸åŒrequesIdelCallbackæ˜¯å› ä¸ºæœ‰å…¼å®¹æ€§ï¼Œä¸”åœ¨åˆ‡æ¢tabæ—¶,æ‰§è¡Œé¢‘ç‡é™ä½ã€‚
4. ä¸ç”¨requestAnimationFrame æ˜¯å› ä¸ºï¼Œå½“å‰é¡µé¢æœªæ¿€æ´»ä¼šåœæ­¢æ‰§è¡Œ

### Reactæ˜¯å¦‚ä½•ä½¿ç”¨Scheduleçš„

***Reactå°†ä»»åŠ¡å’Œä»»åŠ¡çš„ä¼˜å…ˆçº§äº¤ç»™Scheduleç®¡ç†ï¼Œç”±Scheduleæ‰¿æ‹…èµ·ä»»åŠ¡çš„è°ƒåº¦ã€‚***

ä¾‹å¦‚ï¼š

1. fiberæ ‘çš„æ„å»º
2. setState çŠ¶æ€çš„æ›´æ–°

Reactå°†æˆ‘ä»¬äº§ç”Ÿçš„æ›´æ–°ä»¥åŠè¦è¿›è¡Œçš„æ¸²æŸ“ä»»åŠ¡åšäº†ä¼˜å…ˆçº§åŒºåˆ†ï¼Œè®©è°ƒåº¦ç³»ç»ŸScheduleæ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œä»»åŠ¡çš„è°ƒåº¦ã€‚

![Schedule](Schedule.webp)



## Fiberæ ‘çš„æ„å»º

performConcurrentWorkOnRoot

```

```



## React çš„ç”Ÿå‘½å‘¨æœŸ

![fiber](fiber.webp)



### reactæ¸²æŸ“é˜¶æ®µ

##### renderé˜¶æ®µ

reconcileæ—¶å°†vdomè½¬æ¢ä¸ºfiberã€‚

##### commité˜¶æ®µ

å…·ä½“æ“ä½œdomï¼Œä»¥åŠæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°çš„è¿‡ç¨‹ã€‚åˆ†ä¸º3ä¸ªé˜¶æ®µï¼š

1. **before mutation**
2. **mutation**  //æ“ä½œdom
3. **layout**   // refçš„æ›´æ–°, useLayoutEffect çš„æ‰§è¡Œ

## hooks

reactåœ¨ä¸åŒé˜¶æ®µå¼•ç”¨çš„hooksä¸æ˜¯åŒä¸€ä¸ªå‡½æ•°ã€‚mount */update *

```jsx
const App = ()=>{
    const [num,setNum] = useState(111);
    const ref = useRef(1);
    useEffect(()=>{
        setTimeout(()=>{
            setNum(333);
		}, 2000)
    },[]);
    return <div>
    	{num}{ref.current}
    </div>
}
```

### mounté˜¶æ®µğŸŒ

ç¬¬ä¸€æ¬¡è°ƒç”¨use*æ—¶ï¼Œåˆ›å»º**memoizedState** ï¼Œå­˜å‚¨åœ¨**fiber.memoizedState**,åé¢çš„hookæŒ‚åœ¨ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„nextä¸Šã€‚

![memorizedState](memorizedState.webp)

#### useRef

![mountRef](mountRef.webp)

```
åœ¨mountæ—¶ï¼Œå°†å­˜å‚¨åˆ°memoizedState
```

#### useMemo

![mountMemo](C:\Users\å´”å†°å†°\Desktop\notebook\React18\mountMemo.webp)

```jsx
åœ¨mounté˜¶æ®µç¼“å­˜ï¼ŒmemoizedState ç¼“å­˜`è¿”å›å€¼ `å’Œ  `ä¾èµ–æ•°ç»„`
```

#### useCallback

![mountCallback](mountCallback.webp)

### updateé˜¶æ®µ ğŸŒ™

#### useRef

![updateRef](updateRef.webp)

![updateRef2](updateRef2.webp)

```jsx
å–å‡ºhook.memoizedStateã€‚
`è¿”å›çš„refå¯¹è±¡å§‹ç»ˆæ˜¯æœ€å¼€å§‹çš„é‚£ä¸ª`
```

#### useMemo

![updateMemo](C:\Users\å´”å†°å†°\Desktop\notebook\React18\updateMemo.webp)

```jsx
åœ¨updateé˜¶æ®µ,åˆ¤æ–­ä¾èµ–é¡¹æœ‰æ²¡æœ‰æ›´æ”¹ã€‚
1.æ²¡æœ‰æ›´æ”¹å°±è¿”å›æ—§å€¼ï¼Œ
2.æœ‰æ›´æ”¹å°±è¿è¡Œå‡½æ•°,æ›´æ–°hook.memoizedState
```

#### useCallback

![updateCallback](updateCallback.webp)

```
updateCallbackå’ŒuseMemoç±»ä¼¼ï¼Œä¹Ÿä¼šåˆ¤æ–­ä¾èµ–é¡¹ã€‚
```

## useEffect

ä¸¤ä¸ªå‡½æ•°å¯¹åº” ä¸¤ä¸ªé˜¶æ®µ

![mountEffect](mountEffect.webp)

### mounté˜¶æ®µğŸŒ

![mountEffectImpl](mountEffectImpl.webp)

### updateé˜¶æ®µ ğŸŒ™

![updateEffectImpl](updateEffectImpl.webp)

### pushEffectâ­

mount/createé˜¶æ®µéƒ½æ˜¯è¿è¡Œ pushEffectã€‚

![pushEffect](pushEffect.webp)

```jsx
åˆ›å»ºäº†effectï¼Œå¹¶å°†å®ƒæ”¾åˆ°äº†`fiber.updateQueue`ã€‚å¹¶ä¸”updateQueueè¿˜æ˜¯ç¯å½¢é“¾è¡¨ï¼Œåˆ©äºæ–°effectçš„æ’å…¥ã€‚
```

### ä»€ä¹ˆæ—¶å€™æ‰§è¡ŒeffectğŸš¨

åœ¨**commit**æœ€å¼€å§‹çš„æ—¶å€™ï¼Œ**å¼‚æ­¥å¤„ç†effect**ã€‚

### ä¸ºä»€ä¹ˆä¸åœ¨commité˜¶æ®µæ‰§è¡ŒğŸš¨

å¼‚æ­¥æ‰§è¡Œä¸é˜»å¡æ¸²æŸ“ã€‚

## useLayoutEffect

### ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ

åœ¨layouté˜¶æ®µæ‰§è¡Œã€‚

## useEffectå’ŒuseLayoutEffect

### æ‰§è¡Œé¡ºåº

ä¼šå…ˆå¼‚æ­¥è°ƒç”¨useEffectï¼Œå†åŒæ­¥è°ƒç”¨useLayoutEffectï¼Œä½†æ˜¯useLayoutEffectä¼šæ¯”useEffectå…ˆæ‰§è¡Œï¼Œå› ä¸ºuseEffectæ˜¯å¼‚æ­¥æ‰§è¡Œçš„useLayoutEffectæ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚ä¸å»ºè®®ä½¿ç”¨useLayoutEffectï¼Œå› ä¸ºåŒæ­¥æ‰§è¡Œä¼šé˜»å¡æ¸²æŸ“ã€‚

## Effects

![commitEffects](commitEffects.webp)

```jsx
useLayoutEffect çš„effect åœ¨ layouté˜¶æ®µ `commitLayoutEffects`æ—¶éå†æ‰€æœ‰fiber,å–å‡ºupdateQueueä¸­æ¯ä¸ªeffectæ‰§è¡Œã€‚
```

## useStateğŸ§ 

åœ¨18ä¹‹å‰æ˜¯åŒæ­¥è°ƒç”¨æ›´æ–°ï¼Œ18ä¹‹åæ˜¯è‡ªåŠ¨æ‰¹å¤„ç†

### mounté˜¶æ®µ

![mountState](mountState.webp)

1. å°†initialState è®¾ç½®åˆ°hook.baseStateã€‚
2. åˆ›å»ºqueue // ç”¨äºå¤šä¸ªsetState
3. è¿”å›dispatch(ç»‘å®šäº†å½“å‰fiber å’Œ queue)

### è§¦å‘å˜æ›´

è°ƒç”¨setStateï¼ˆä¹Ÿå°±æ˜¯dispatchï¼‰è§¦å‘å˜æ›´ã€‚

![dispatchSetState](dispatchSetState.webp)

```jsx
fiberå’Œqueueæ˜¯æˆ‘ä»¬mounté˜¶æ®µæ—¶ä¼ å…¥çš„å‚æ•°ï¼Œactionæ˜¯æˆ‘ä»¬ä¼ å…¥çš„æ–°å€¼ã€‚
```

dispatchSetStateå‡½æ•°ï¼š

![dispatchSetStateå†…éƒ¨](dispatchSetStateå†…éƒ¨.webp)

1. åˆ›å»ºupdateå¯¹è±¡ï¼Œæ ‡è®°fiberèŠ‚ç‚¹æœ‰æ›´æ–°[ä»å½“å‰fiberç›´åˆ°root]ï¼Œè°ƒåº¦ä¸‹æ¬¡æ¸²æŸ“ã€‚
2. scheduleUpdateOnFiber å†…éƒ¨ä¼šè°ƒç”¨ renderRootSync(å¼€å¯æ–°çš„vdomè½¬)

### updateé˜¶æ®µ

![updateState](updateState.webp)

#### å¤šä¸ªsetStateï¼Œå¦‚ä½•ç¡®å®šæœ€ç»ˆæ›´æ–°æˆå“ªä¸ªå€¼ï¼Ÿ

```
æ ¹æ®laneæ¯”è¾ƒï¼Œåšstateçš„åˆå¹¶ã€‚æœ€åè¿”å›ä¸€ä¸ªæ–°çš„stateã€‚
```

# Fiberæ¶æ„çš„æ„ä¹‰

å°†å•ä¸ª`React element`ä½œä¸º`å·¥ä½œå•å…ƒ`ï¼Œä½¿ä»¥`React element`ä¸ºç²’åº¦çš„`å¼‚æ­¥å¯ä¸­æ–­çš„æ›´æ–°`æˆä¸ºå¯èƒ½ã€‚

æ¯ä¸ª`FiberèŠ‚ç‚¹`å¯¹åº”ä¸€ä¸ª` React element`,ä¿å­˜äº†è¯¥ç»„ä»¶çš„ç±»å‹(å‡½æ•°ç»„ä»¶/ç±»ç»„ä»¶...)ï¼Œå¯¹åº”çš„DOMèŠ‚ç‚¹ä¿¡æ¯ã€‚

## æ¶æ„çš„é©±åŠ¨åŠ› -Scheduler

Scheduler

1. æ—¶é—´åˆ‡ç‰‡
2. ä¼˜å…ˆçº§è°ƒåº¦

### æ—¶é—´åˆ‡ç‰‡

åœ¨æµè§ˆå™¨æ¯ä¸€å¸§çš„æ—¶é—´ä¸­ï¼Œé¢„ç•™ä¸€äº›æ—¶é—´ç»™JSçº¿ç¨‹ï¼Œ`React`åˆ©ç”¨è¿™éƒ¨åˆ†æ—¶é—´æ›´æ–°ç»„ä»¶ã€‚å½“é¢„ç•™çš„æ—¶é—´ä¸å¤Ÿç”¨æ—¶ï¼Œ`React`å°†çº¿ç¨‹æ§åˆ¶æƒäº¤ç»™æµè§ˆå™¨ä½¿å…¶æœ‰æ—¶é—´æ¸²æŸ“UIï¼Œ`React`åˆ™ç­‰å¾…ä¸‹ä¸€å¸§æ—¶é—´æ¥ç»§ç»­è¢«ä¸­æ–­çš„å·¥ä½œã€‚

`æ—¶é—´åˆ‡ç‰‡`çš„æœ¬è´¨æ˜¯æ¨¡æ‹Ÿå®ç°[requestIdleCallback](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback)ã€‚

## æ¶æ„è¿è¡Œç­–ç•¥ -laneæ¨¡å‹

laneæ¨¡å‹

## Fiberæ ‘ğŸŒ³

### FiberèŠ‚ç‚¹ğŸŒ¿

æ¯ä¸€ä¸ªfiberèŠ‚ç‚¹å¯¹åº”ç€ä¸€ä¸ªå…ƒç´ [ç»„ä»¶ï¼ŒDOM]

```
function FiberNode(
  tag: WorkTag,
  pendingProps: mixed,
  key: null | string,
  mode: TypeOfMode,
) {
  // ä½œä¸ºé™æ€æ•°æ®ç»“æ„çš„å±æ€§
  this.tag = tag;
  this.key = key;
  this.elementType = null;
  this.type = null;
  this.stateNode = null;

  // ç”¨äºè¿æ¥å…¶ä»–FiberèŠ‚ç‚¹å½¢æˆFiberæ ‘
  this.return = null;
  this.child = null;
  this.sibling = null;
  this.index = 0;

  this.ref = null;

  // ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒçš„å±æ€§
  this.pendingProps = pendingProps;
  this.memoizedProps = null;
  this.updateQueue = null;
  this.memoizedState = null;
  this.dependencies = null;

  this.mode = mode;

  this.effectTag = NoEffect;
  this.nextEffect = null;

  this.firstEffect = null;
  this.lastEffect = null;

  // è°ƒåº¦ä¼˜å…ˆçº§ç›¸å…³
  this.lanes = NoLanes;
  this.childLanes = NoLanes;

  // æŒ‡å‘è¯¥fiberåœ¨å¦ä¸€æ¬¡æ›´æ–°æ—¶å¯¹åº”çš„fiber
  this.alternate = null;
}
```

#### Fiberæ ‘çš„éå†

å…ˆåºéå†[ä¸­->å·¦->å³]

#### Fiberæ ‘çš„ä¼˜åŠ¿

DOMå¤šå‰æ ‘ï¼š

```typescript
`å½“å‰èŠ‚ç‚¹å‚¨å­˜å­èŠ‚ç‚¹ä¿¡æ¯:`
{
	...,
	children
}
`éå†èŠ‚ç‚¹ï¼š`
function deep(node){
    if(!node)return;
    const {value,children = []} = node;
    console.log(value);
    for(let i = 0;i<children.length;i++){
        deep(children[i])
    }
}
åœ¨DOMåµŒå¥—å¾ˆæ·±æ—¶ï¼Œé€’å½’ä¼šå ç”¨å¤§é‡çš„èµ„æºã€‚
JSçº¿ç¨‹å’ŒGUIçº¿ç¨‹æ˜¯äº’æ–¥çš„ï¼Œæ‰€ä»¥å¯èƒ½çœ‹åˆ°UIå¡é¡¿ã€‚
```

Fiberæ ‘ï¼š

```typescript
`FiberèŠ‚ç‚¹`:
type Fiber = {
    type:any,
    //....
    child:Fiber,
    sibling:Fiber,
    return:Fiber
}
// éå†èŠ‚ç‚¹
function traverse(node){
    let root = node;
    let current = node;
    while(true){
        if(current.child){
            current = current.child;
            continue;
        }
        if(current.sibling){
            current = current.sibling;
            continue;
        }
        while(!current.sibling){
            if(current.return == null || current.return == root){
				return
            }
            current = current.return;
        }
    }
}
```

1. ç›¸æ¯”äºDOMå¤šå‰æ ‘, Fiberå¯ä»¥æ‘’å¼ƒé€’å½’,è°ƒç”¨æ ˆåªä½¿ç”¨äº†ä¸€å±‚ï¼Œæå‡äº†æ€§èƒ½ã€‚
2. å…è®¸ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æ‰“æ–­ã€‚æ‰€ä»¥éå†è¿‡ç¨‹å¯èƒ½éšæ—¶è¢«æ‰“æ–­ï¼Œæ‰€ä»¥è¦è®°å½•ä¸­æ–­ç‚¹ã€‚

### FiberèŠ‚ç‚¹ğŸŒ¿

#### ClickCounter ç»„ä»¶

```jsx
{
    stateNode: new ClickCounter,
    type: ClickCounter,
    alternate: null,
    key: null,
    updateQueue: null, // å­˜å‚¨ effect ä¿¡æ¯
    memoizedState: {count: 0}, // å­˜å‚¨hooksä¿¡æ¯
    pendingProps: {},
    memoizedProps: {},
    tag: 1,
    effectTag: 0,
    nextEffect: null
}
```

#### spanå…ƒç´ 

```jsx
{
    stateNode: new HTMLSpanElement,
    type: "span",
    alternate: null,
    key: "2",
    updateQueue: null,
    memoizedState: null,
    pendingProps: {children: 0},
    memoizedProps: {children: 0},
    tag: 5,
    effectTag: 0,
    nextEffect: null
}
```

```jsx
`stateNode`:ç»„ä»¶å®ä¾‹/DOMèŠ‚ç‚¹/å…¶ä»–Reactå…ƒç´ ç±»å‹
`type`:å®šä¹‰ä¸fiberå…³è”çš„å‡½æ•°/ç±»ã€‚ç±»ç»„ä»¶æŒ‡å‘æ„é€ å‡½æ•°,DOMå…ƒç´ æŒ‡å‘æ ‡ç­¾
`tag`ï¼šå®šä¹‰fiberç±»å‹ // ç±»ç»„ä»¶/å‡½æ•°ç»„ä»¶/æ™®é€šDOM
`updateQueue`:çŠ¶æ€æ›´æ–°ï¼Œå›è°ƒå’ŒDOMæ›´æ–°çš„é˜Ÿåˆ—[åœ¨ç±»ç»„ä»¶ä¸­ä½¿ç”¨çš„æ›´æ–°é˜Ÿåˆ—]
`memoizedState`:ä¿å­˜fiberçš„çŠ¶æ€ã€‚åœ¨å¤„ç†æ›´æ–°æ—¶ï¼Œä¼šåæ˜ å½“å‰åœ¨å±å¹•ä¸Šå‘ˆç°çš„çŠ¶æ€ã€‚
				//åœ¨ç±»ç»„ä»¶ä¸­memoizedStateç”¨äºä¿å­˜çŠ¶æ€(state)
				//å‡½æ•°ç»„ä»¶ä¸­memoizedStateç”¨æ¥ä¿å­˜hooké“¾è¡¨
`memoizedProps`ï¼šä¸Šä¸€æ¬¡æ¸²æŸ“æœŸé—´ä½¿ç”¨çš„props
`pendingProps`ï¼šæ–°çš„React elementä¸­çš„æ•°æ®æ›´æ–°åçš„propsï¼Œéœ€è¦åº”ç”¨åˆ°å­ç»„ä»¶/DOMå…ƒç´ ä¸Šã€‚
`key`ï¼šä¸€ç»„èŠ‚ç‚¹çš„å”¯ä¸€æ ‡å¿—ï¼Œç”¨äºå¸®åŠ©Reactç¡®å®šå“ªäº›å…ƒç´ éœ€è¦å¢/åˆ /æ”¹
```

## ä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†ğŸš¦

### Laneæ¨¡å‹

1. è¿‡æœŸä»»åŠ¡/åŒæ­¥ä»»åŠ¡ä½¿ç”¨`åŒæ­¥`ä¼˜å…ˆçº§
2. ç”¨æˆ·äº¤äº’äº§ç”Ÿçš„æ›´æ–°(ç‚¹å‡»)ä½¿ç”¨æ›´é«˜ä¼˜å…ˆçº§
3. ç½‘ç»œè¯·æ±‚äº§ç”Ÿçš„æ›´æ–°ä½¿ç”¨ä¸€èˆ¬ä¼˜å…ˆçº§
4. `Suspense`ä½¿ç”¨ä½ä¼˜å…ˆçº§



1. å¦‚ä½•ä¸ºReactä¸åŒäº‹ä»¶æ·»åŠ ä¸åŒçš„ä¼˜å…ˆçº§ï¼Ÿ

1. createRootåˆ›å»ºæ ¹èŠ‚ç‚¹åï¼Œä¼šä¸ºrootèŠ‚ç‚¹æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œåšäº‹ä»¶å§”æ‰˜ã€‚
2. æ ¹æ®è·å–åˆ°çš„äº‹ä»¶çš„ä¼˜å…ˆçº§åˆ†ç±»ï¼Œè®¾ç½®äº‹ä»¶è§¦å‘æ—¶æ‹¥æœ‰å¯¹åº”ä¼˜å…ˆçº§çš„å›è°ƒå‡½æ•°



`requestIdleCallback`: æµè§ˆå™¨åˆ‡æ¢tabå.ä¹‹å‰tabçš„`requestIdleCallback`è§¦å‘çš„é¢‘ç‡ä¼šå˜å¾—å¾ˆä½ã€‚

**Scheduler**ï¼šè‡ªèº«å®ç°









![Reconciliation](Reconciliation.png)

## åè°ƒé˜¶æ®µğŸ“

Reconciler  å¯ä»¥å¼‚æ­¥æ‰§è¡Œ

**åè°ƒé˜¶æ®µ**:ç”¨æ–°çš„æ•°æ®ç”Ÿæˆä¸€ä¸ªæ–°çš„æ ‘ï¼Œé€šè¿‡diffç®—æ³•éå†æ—§æ ‘ï¼Œå¿«é€Ÿæ‰¾åˆ°éœ€è¦æ›´æ–°çš„å…ƒç´ ï¼Œæ”¾åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­ã€‚

**âš ï¸**åè°ƒé˜¶æ®µå¯èƒ½è¢«ä¸­æ–­ï¼Œæ¢å¤ï¼Œç”šè‡³é‡åšã€‚

### ä¸ºä»€ä¹ˆå¯ä»¥è¢«ä¸­æ–­

1. å› ä¸ºåœ¨å½“å‰é˜¶æ®µä¸ä¼šå¯¼è‡´ç”¨æˆ·å¯è§çš„æ›´æ”¹

### ä¸ºä»€ä¹ˆä¼šä¸­æ–­

1. å› ä¸ºreactå¾—åˆ°æ§åˆ¶æƒåï¼Œåº”è¯¥å¤„ç†æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚ä¸­æ–­æ—¶æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œåœ¨æ¢å¤æ—¶ä¼šè®©ä½ç»™æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ŒåŸæœ¬ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½ä¼šè¢«æ”¾å¼ƒæˆ–è€…é‡åšã€‚

## æäº¤é˜¶æ®µğŸ“Œ

Commit åªèƒ½åŒæ­¥æ‰§è¡Œ

### ä¸ºä»€ä¹ˆåªèƒ½åŒæ­¥ä¸”ä¸€æ¬¡æ€§æ‰§è¡Œ

1. å› ä¸ºåœ¨commité˜¶æ®µæ‰§è¡Œçš„å·¥ä½œä¼šå¯¼è‡´ç”¨æˆ·å¯è§çš„æ›´æ”¹ã€‚ä¾‹å¦‚DOMçš„æ›´æ–°

å°†å˜æ›´æ“ä½œåº”ç”¨åˆ°é¡µé¢ä¸Šã€‚

**âš ï¸**ä¸å¯è¢«æ‰“æ–­ã€‚



## Effects list

### å‰¯ä½œç”¨åˆ—è¡¨

1. c2æ’å…¥DOM
2. d2å’Œc1æ›´æ–°å±æ€§
3. ...

![effectList](effectList.png)

### å‰¯ä½œç”¨é“¾è¡¨

![effectList2](effectList2.png)





## åŒç¼“å­˜

# jsxâš¡

ClickCounter

```jsx
<button key="1" onClick={this.onClick}>Update counter</button>
<span key="2">{this.state.count}</span>
```

babelç¼–è¯‘ğŸ‘†ï¼Œè¾“å‡ºğŸ‘‡

```jsx
render() {
        return [
            React.createElement(
                'button',
                {
                    key: '1',
                    onClick: this.onClick
                },
                'Update counter'
            ),
            React.createElement(
                'span',
                {
                    key: '2'
                },
                this.state.count
            )
        ]
}
```

**React.createElement **å¤„ç†ğŸ‘†ï¼Œè¾“å‡ºğŸ‘‡ è™šæ‹ŸDOMæ ‘

```jsx
[
    {
        $$typeof: Symbol(react.element),  
        type: 'button',
        key: "1",
        props: {
            children: 'Update counter',
            onClick: () => { ... }
        }
    },
    {
        $$typeof: Symbol(react.element),
        type: 'span',
        key: "2",
        props: {
            children: 0
        }
    }
]
```

# é—®é¢˜

## ä¸ºä»€ä¹ˆè¦å…ˆå°†å­èŠ‚ç‚¹æ’å…¥çˆ¶èŠ‚ç‚¹ï¼Œæœ€åå†æ’å…¥åˆ°æµè§ˆå™¨ï¼Ÿ

å› ä¸ºå¦‚æœå…ˆå°†çˆ¶èŠ‚ç‚¹æ’å…¥æµè§ˆå™¨ï¼Œä¼šè§¦å‘å›æµï¼Œå†å°†å­èŠ‚ç‚¹æ’å…¥çˆ¶èŠ‚ç‚¹åˆä¼šè§¦å‘å›æµï¼Œæ€§èƒ½å·®

# æ–‡æ¡£

[React Hooks useState ä½¿ç”¨è¯¦è§£+å®ç°åŸç†+æºç åˆ†æ](https://juejin.cn/post/7076456859611168776)

[ReactæŠ€æœ¯è§£å¯†](https://react.iamkasong.com/)

[ä¸€ç¯‡é•¿æ–‡å¸®ä½ å½»åº•ææ‡‚Reactçš„è°ƒåº¦æœºåˆ¶åŸç†](https://segmentfault.com/a/1190000039101758)

[ææ‡‚ useState å’Œ useEffect çš„å®ç°åŸç†](https://juejin.cn/post/7203336895887114300?share_token=ab9a7129-05bb-4cb5-bfb1-e63b30e5c8b6)

[è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼](https://juejin.cn/post/6844903975112671239)

